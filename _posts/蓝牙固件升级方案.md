### 何为固件升级？ 固件为什么需要升级？

 > 大家也许有做过硬件（蓝牙）固件升级的开发，举个栗子：
用手机设备中心通过蓝牙硬件去操控某个硬件的场景，蓝牙固件是安装在我们的实物（车辆、门禁、智能家电等），那么大家都很熟悉的我们平时使用的手机app，开发商推出新功能或者修复了什么问题，都是通过升级版本来让安装该app的Client进行升级获得最新的安装包，从而达到把新功能安装到用户手机的作用，那么固件同样也具备固件升级的流程和需求。
例如：某汽车上安装了一个TBOX固件，该固件版本号为1.0，功能是通过蓝牙和设备中心（手机）连接，可以对车辆的门、窗、熄火检测等进行操作，假如我们的固件产品研发了一个新的功能，可以通过固件读取该车辆的油量，但是固件已经悉数安装到上千台车辆上，而且车辆已经行驶在全国各地的道路上，那么统一开回指定地点进行固件拆卸重新安装新的固件是非常不显示也是不可能的，这个时候就需要我们对已安装的固件进行远程网络升级操作，以达到固件功能迭代的作用，那么，具体如何升级固件呢，请往下看。

### 固件升级步骤和方案 

- 1>  首先，固件本身有一个版本号，比如是：1.0，然后我们做了自己的服务器管理这个固件升级的部分，对版本号进行管理，硬件同事每开发一个版本，就像git一样提交，然后我们会去更新服务器存的最新的版本，比如服务器最新版本是：2.0

- 2>  固件设定升级时机，这个要根据业务需求，拿我们的需求场景来说（分时租赁业务），就是固件检测到当前没有人用车（也就是说当前固件没有被人连接，并且固件flash里面没有存储的数据了）也就是车辆闲置，发动机状态，这个可以写一个函数，去设置一个适合升级的时间，一旦达到可升级的要求，那么固件会像服务器进行通讯，告诉服务器自己的当前版本号，然后服务器拿到是个1.0，而最新的是2.0，那么这个时候服务器就会告诉固件，你需要升级了，当前服务器最新的版本是2.0，然后固件拿到消息后，在刚才我说的那个设定好的时机 去向服务器通讯，也就是 下载新的安装包（bin2进制文件）

- 3>  安装包一般比较大，固件会做一个拆分去向服务器要，比如 这个包一共 10M，那么固件将他拆分为 10个包，那么每个包就是1M，然后分10次向服务器要，每回过来一个包，固件会将数据写入到flash，flash就是固件存储数据的地方，可以理解成固件的硬盘，然后最后10个包全都拿到，然后固件将10个包组包，然后写入文件，写完之后，自动重启固件，也就完成了固件升级的工作

#### 需要注意的问题 
 > 需要注意的是，升级过程中数据传输需要做校验位校验，这个校验是干嘛的呢，就是说服务器给固件的第一个包会告诉固件这次的新包一共多大，也就是刚才我说的那个10M，这个校验算法，是一种标准的算法，网上有，服务器给固件回包的时候，会对整个包做校验算法，比如算的结果得到一个校验码是：234578，然后会在第一个包告诉固件，然后等固件拿到所有的包进行组包之后，也要对收到的数据进行校验位校验，如果校验结果 也是 234578，那么就说明没有丢包等异常，这个包是ok的，如果校验码不是234578，那就说明中间有丢包或者加解密不对的情况，这个包就不能要了，就要删掉，重新给服务器再要

### 个人宣传广告位：
[shLuckySeven](https://github.com/shLuckySeven)
