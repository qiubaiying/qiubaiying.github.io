I"ær<blockquote>
  <p>æœ¬æ–‡è½¬è½½è‡ªç¾å›¾ç‚¹è¯„æŠ€æœ¯å›¢é˜Ÿçš„ï¼š<a href="http://tech.meituan.com/DiveIntoCategory.html">æ·±å…¥ç†è§£Objective-Cï¼šCategory</a>ï¼Œç•¥æœ‰ä¿®æ”¹ã€‚</p>
</blockquote>

<h1 id="å‰è¨€">å‰è¨€</h1>

<p>æ— è®ºä¸€ä¸ªç±»è®¾è®¡çš„å¤šä¹ˆå®Œç¾ï¼Œåœ¨æœªæ¥çš„éœ€æ±‚æ¼”è¿›ä¸­ï¼Œéƒ½æœ‰å¯èƒ½ä¼šç¢°åˆ°ä¸€äº›æ— æ³•é¢„æµ‹çš„æƒ…å†µã€‚é‚£æ€ä¹ˆæ‰©å±•å·²æœ‰çš„ç±»å‘¢ï¼Ÿä¸€èˆ¬è€Œè¨€ï¼Œç»§æ‰¿å’Œç»„åˆæ˜¯ä¸é”™çš„é€‰æ‹©ã€‚ä½†æ˜¯åœ¨Objective-C 2.0ä¸­ï¼Œåˆæä¾›äº†categoryè¿™ä¸ªè¯­è¨€ç‰¹æ€§ï¼Œå¯ä»¥åŠ¨æ€åœ°ä¸ºå·²æœ‰ç±»æ·»åŠ æ–°è¡Œä¸ºã€‚å¦‚ä»Šcategoryå·²ç»éå¸ƒäºObjective-Cä»£ç çš„å„ä¸ªè§’è½ï¼Œä»Appleå®˜æ–¹çš„frameworkåˆ°å„ä¸ªå¼€æºæ¡†æ¶ï¼Œä»åŠŸèƒ½ç¹å¤çš„å¤§å‹APPåˆ°ç®€å•çš„åº”ç”¨ï¼Œcatagoryæ— å¤„ä¸åœ¨ã€‚æœ¬æ–‡å¯¹categoryåšäº†æ¯”è¾ƒå…¨é¢çš„æ•´ç†ï¼Œå¸Œæœ›å¯¹è¯»è€…æœ‰æ‰€è£¨ç›Šã€‚</p>

<h1 id="ç®€ä»‹">ç®€ä»‹</h1>

<p>æœ¬æ–‡ç³»å­¦ä¹ Objective-Cçš„runtimeæºç æ—¶æ•´ç†æ‰€æˆï¼Œä¸»è¦å‰–æäº†categoryåœ¨runtimeå±‚çš„å®ç°åŸç†ä»¥åŠå’Œcategoryç›¸å…³çš„æ–¹æ–¹é¢é¢ï¼Œå†…å®¹åŒ…æ‹¬ï¼š</p>

<ul>
  <li>åˆå…¥å®åœ° categoryç®€ä»‹</li>
  <li>è¿ç±»æ¯”äº‹ categoryå’Œextension</li>
  <li>æŒ‘ç¯ç»†è§ˆ categoryçœŸé¢ç›®</li>
  <li>è¿½æœ¬æº¯æº categoryå¦‚ä½•åŠ è½½</li>
  <li>æ—ææœ«å¶ categoryå’Œ+loadæ–¹æ³•</li>
  <li>è§¦ç±»æ—é€š categoryå’Œæ–¹æ³•è¦†ç›–</li>
  <li>æ›´ä¸Šä¸€å±‚ categoryå’Œå…³è”å¯¹è±¡</li>
</ul>

<h2 id="åˆå…¥å®åœ°-categoryç®€ä»‹">åˆå…¥å®åœ° Categoryç®€ä»‹</h2>

<p>Categoryæ˜¯Objective-C 2.0ä¹‹åæ·»åŠ çš„è¯­è¨€ç‰¹æ€§ï¼ŒCategoryçš„ä¸»è¦ä½œç”¨æ˜¯ä¸ºå·²ç»å­˜åœ¨çš„ç±»æ·»åŠ æ–¹æ³•ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œappleè¿˜æ¨èäº†Categoryçš„å¦å¤–ä¸¤ä¸ªä½¿ç”¨åœºæ™¯,è¯¦è§<a href="https://developer.apple.com/library/content/documentation/General/Conceptual/DevPedia-CocoaCore/Category.html">Apple Categoryæ–‡æ¡£</a>ã€‚</p>

<ul>
  <li>å¯ä»¥æŠŠç±»çš„å®ç°åˆ†å¼€åœ¨å‡ ä¸ªä¸åŒçš„æ–‡ä»¶é‡Œé¢ã€‚è¿™æ ·åšæœ‰å‡ ä¸ªæ˜¾è€Œæ˜“è§çš„å¥½å¤„ï¼Œ
    <ul>
      <li>å¯ä»¥å‡å°‘å•ä¸ªæ–‡ä»¶çš„ä½“ç§¯ b)å¯ä»¥æŠŠä¸åŒçš„åŠŸèƒ½ç»„ç»‡åˆ°ä¸åŒçš„categoryé‡Œ</li>
      <li>å¯ä»¥ç”±å¤šä¸ªå¼€å‘è€…å…±åŒå®Œæˆä¸€ä¸ªç±»</li>
      <li>å¯ä»¥æŒ‰éœ€åŠ è½½æƒ³è¦çš„ Category ç­‰ç­‰ã€‚</li>
    </ul>
  </li>
  <li>å£°æ˜ç§æœ‰æ–¹æ³•</li>
</ul>

<p>ä¸è¿‡é™¤äº†appleæ¨èçš„ä½¿ç”¨åœºæ™¯ï¼Œå¹¿å¤§å¼€å‘è€…è„‘æ´å¤§å¼€ï¼Œè¿˜è¡ç”Ÿå‡ºäº†categoryçš„å…¶ä»–å‡ ä¸ªä½¿ç”¨åœºæ™¯ï¼š</p>

<ul>
  <li>æ¨¡æ‹Ÿå¤šç»§æ‰¿</li>
  <li>æŠŠframeworkçš„ç§æœ‰æ–¹æ³•å…¬å¼€</li>
</ul>

<p>Objective-Cçš„è¿™ä¸ªè¯­è¨€ç‰¹æ€§å¯¹äºçº¯åŠ¨æ€è¯­è¨€æ¥è¯´å¯èƒ½ä¸ç®—ä»€ä¹ˆï¼Œæ¯”å¦‚javascriptï¼Œä½ å¯ä»¥éšæ—¶ä¸ºä¸€ä¸ªâ€œç±»â€æˆ–è€…å¯¹è±¡æ·»åŠ ä»»æ„æ–¹æ³•å’Œå®ä¾‹å˜é‡ã€‚ä½†æ˜¯å¯¹äºä¸æ˜¯é‚£ä¹ˆâ€œåŠ¨æ€â€çš„è¯­è¨€è€Œè¨€ï¼Œè¿™ç¡®å®æ˜¯ä¸€ä¸ªäº†ä¸èµ·çš„ç‰¹æ€§ã€‚</p>

<h2 id="è¿ç±»æ¯”äº‹-categoryå’Œextension">è¿ç±»æ¯”äº‹ Categoryå’ŒExtension</h2>

<p>extensionçœ‹èµ·æ¥å¾ˆåƒä¸€ä¸ªåŒ¿åçš„categoryï¼Œä½†æ˜¯extensionå’Œæœ‰åå­—çš„categoryå‡ ä¹å®Œå…¨æ˜¯ä¸¤ä¸ªä¸œè¥¿ã€‚ extensionåœ¨ç¼–è¯‘æœŸå†³è®®ï¼Œå®ƒå°±æ˜¯ç±»çš„ä¸€éƒ¨åˆ†ï¼Œåœ¨ç¼–è¯‘æœŸå’Œå¤´æ–‡ä»¶é‡Œçš„@interfaceä»¥åŠå®ç°æ–‡ä»¶é‡Œçš„@implementä¸€èµ·å½¢æˆä¸€ä¸ªå®Œæ•´çš„ç±»ï¼Œå®ƒä¼´éšç±»çš„äº§ç”Ÿè€Œäº§ç”Ÿï¼Œäº¦éšä¹‹ä¸€èµ·æ¶ˆäº¡ã€‚extensionä¸€èˆ¬ç”¨æ¥éšè—ç±»çš„ç§æœ‰ä¿¡æ¯ï¼Œä½ å¿…é¡»æœ‰ä¸€ä¸ªç±»çš„æºç æ‰èƒ½ä¸ºä¸€ä¸ªç±»æ·»åŠ extensionï¼Œæ‰€ä»¥ä½ æ— æ³•ä¸ºç³»ç»Ÿçš„ç±»æ¯”å¦‚NSStringæ·»åŠ extensionã€‚(è¯¦è§<a href="https://developer.apple.com/library/content/documentation/Cocoa/Conceptual/ProgrammingWithObjectiveC/CustomizingExistingClasses/CustomizingExistingClasses.html">Appleæ–‡æ¡£</a>)</p>

<h2 id="æŒ‘ç¯ç»†è§ˆ-categoryçœŸé¢ç›®">æŒ‘ç¯ç»†è§ˆ categoryçœŸé¢ç›®</h2>

<p>æˆ‘ä»¬çŸ¥é“ï¼Œæ‰€æœ‰çš„OCç±»å’Œå¯¹è±¡ï¼Œåœ¨runtimeå±‚éƒ½æ˜¯ç”¨structè¡¨ç¤ºçš„ï¼Œcategoryä¹Ÿä¸ä¾‹å¤–ï¼Œåœ¨runtimeå±‚ï¼Œcategoryç”¨ç»“æ„ä½“category_tï¼ˆåœ¨objc-runtime-new.hä¸­å¯ä»¥æ‰¾åˆ°æ­¤å®šä¹‰ï¼‰ï¼Œå®ƒåŒ…å«äº†</p>

<ol>
  <li>ç±»çš„åå­—ï¼ˆnameï¼‰
    <ul>
      <li>ç±»ï¼ˆclsï¼‰</li>
      <li>categoryä¸­æ‰€æœ‰ç»™ç±»æ·»åŠ çš„å®ä¾‹æ–¹æ³•çš„åˆ—è¡¨ï¼ˆinstanceMethodsï¼‰</li>
      <li>categoryä¸­æ‰€æœ‰æ·»åŠ çš„ç±»æ–¹æ³•çš„åˆ—è¡¨ï¼ˆclassMethodsï¼‰</li>
      <li>categoryå®ç°çš„æ‰€æœ‰åè®®çš„åˆ—è¡¨ï¼ˆprotocolsï¼‰</li>
      <li>categoryä¸­æ·»åŠ çš„æ‰€æœ‰å±æ€§ï¼ˆinstancePropertiesï¼‰</li>
    </ul>
  </li>
</ol>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>typedef struct category_t {
    const char *name;
    classref_t cls;
    struct method_list_t *instanceMethods;
    struct method_list_t *classMethods;
    struct protocol_list_t *protocols;
    struct property_list_t *instanceProperties;
} category_t;
</code></pre></div></div>
<p>ä»categoryçš„å®šä¹‰ä¹Ÿå¯ä»¥çœ‹å‡ºcategoryçš„å¯ä¸ºï¼ˆå¯ä»¥æ·»åŠ å®ä¾‹æ–¹æ³•ï¼Œç±»æ–¹æ³•ï¼Œç”šè‡³å¯ä»¥å®ç°åè®®ï¼Œæ·»åŠ å±æ€§ï¼‰å’Œä¸å¯ä¸ºï¼ˆæ— æ³•æ·»åŠ å®ä¾‹å˜é‡ï¼‰ã€‚
okï¼Œæˆ‘ä»¬å…ˆå»å†™ä¸€ä¸ªcategoryçœ‹ä¸€ä¸‹categoryåˆ°åº•ä¸ºä½•ç‰©ï¼š</p>

<p>MyClass.hï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#import &lt;Foundation/Foundation.h&gt;

@interface MyClass : NSObject

- (void)printName;

@end

@interface MyClass(MyAddition)

@property(nonatomic, copy) NSString *name;

- (void)printName;

@end
</code></pre></div></div>
<p>MyClass.mï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#import "MyClass.h"

@implementation MyClass

- (void)printName
{
    NSLog(@"%@",@"MyClass");
}

@end

@implementation MyClass(MyAddition)

- (void)printName
{
    NSLog(@"%@",@"MyAddition");
}

@end
</code></pre></div></div>

<p>æˆ‘ä»¬ä½¿ç”¨clangçš„å‘½ä»¤å»çœ‹çœ‹categoryåˆ°åº•ä¼šå˜æˆä»€ä¹ˆï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>clang -rewrite-objc MyClass.m
</code></pre></div></div>
<p>å¥½å§ï¼Œæˆ‘ä»¬å¾—åˆ°äº†ä¸€ä¸ª3Må¤§å°ï¼Œ10wå¤šè¡Œçš„.cppæ–‡ä»¶ï¼ˆè¿™ç»å¯¹æ˜¯Appleå€¼å¾—åæ§½çš„ä¸€ç‚¹ï¼‰ï¼Œæˆ‘ä»¬å¿½ç•¥æ‰æ‰€æœ‰å’Œæˆ‘ä»¬æ— å…³çš„ä¸œè¥¿ï¼Œåœ¨æ–‡ä»¶çš„æœ€åï¼Œæˆ‘ä»¬æ‰¾åˆ°äº†å¦‚ä¸‹ä»£ç ç‰‡æ®µï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>static struct /*_method_list_t*/ {
unsigned int entsize;  // sizeof(struct _objc_method)
unsigned int method_count;
struct _objc_method method_list[1];
} _OBJC_$_CATEGORY_INSTANCE_METHODS_MyClass_$_MyAddition __attribute__ ((used, section ("__DATA,__objc_const"))) = {
sizeof(_objc_method),
1,

};

static struct /*_prop_list_t*/ {
unsigned int entsize;  // sizeof(struct _prop_t)
unsigned int count_of_properties;
struct _prop_t prop_list[1];
} _OBJC_$_PROP_LIST_MyClass_$_MyAddition __attribute__ ((used, section ("__DATA,__objc_const"))) = {
sizeof(_prop_t),
1,
name
};

extern "C" __declspec(dllexport) struct _class_t OBJC_CLASS_$_MyClass;

static struct _category_t _OBJC_$_CATEGORY_MyClass_$_MyAddition __attribute__ ((used, section ("__DATA,__objc_const"))) =
{
"MyClass",
0, // &amp;OBJC_CLASS_$_MyClass,
(const struct _method_list_t *)&amp;_OBJC_$_CATEGORY_INSTANCE_METHODS_MyClass_$_MyAddition,
0,
0,
(const struct _prop_list_t *)&amp;_OBJC_$_PROP_LIST_MyClass_$_MyAddition,
};
static void OBJC_CATEGORY_SETUP_$_MyClass_$_MyAddition(void ) {
_OBJC_$_CATEGORY_MyClass_$_MyAddition.cls = &amp;OBJC_CLASS_$_MyClass;
}
#pragma section(".objc_inithooks$B", long, read, write)
__declspec(allocate(".objc_inithooks$B")) static void *OBJC_CATEGORY_SETUP[] = {
(void *)&amp;OBJC_CATEGORY_SETUP_$_MyClass_$_MyAddition,
};
static struct _class_t *L_OBJC_LABEL_CLASS_$ [1] __attribute__((used, section ("__DATA, __objc_classlist,regular,no_dead_strip")))= {
&amp;OBJC_CLASS_$_MyClass,
};
static struct _class_t *_OBJC_LABEL_NONLAZY_CLASS_$[] = {
&amp;OBJC_CLASS_$_MyClass,
};
static struct _category_t *L_OBJC_LABEL_CATEGORY_$ [1] __attribute__((used, section ("__DATA, __objc_catlist,regular,no_dead_strip")))= {
&amp;_OBJC_$_CATEGORY_MyClass_$_MyAddition,
};
</code></pre></div></div>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œ</p>

<ol>
  <li>é¦–å…ˆç¼–è¯‘å™¨ç”Ÿæˆäº†å®ä¾‹æ–¹æ³•åˆ—è¡¨OBJC$_CATEGORY_INSTANCE_METHODSMyClass$_MyAdditionå’Œå±æ€§åˆ—è¡¨OBJC$_PROP_LISTMyClass$_MyAdditionï¼Œä¸¤è€…çš„å‘½åéƒ½éµå¾ªäº†å…¬å…±å‰ç¼€+ç±»å+categoryåå­—çš„å‘½åæ–¹å¼ï¼Œè€Œä¸”å®ä¾‹æ–¹æ³•åˆ—è¡¨é‡Œé¢å¡«å……çš„æ­£æ˜¯æˆ‘ä»¬åœ¨MyAdditionè¿™ä¸ªcategoryé‡Œé¢å†™çš„æ–¹æ³•printNameï¼Œè€Œå±æ€§åˆ—è¡¨é‡Œé¢å¡«å……çš„ä¹Ÿæ­£æ˜¯æˆ‘ä»¬åœ¨MyAdditioné‡Œæ·»åŠ çš„nameå±æ€§ã€‚è¿˜æœ‰ä¸€ä¸ªéœ€è¦æ³¨æ„åˆ°çš„äº‹å®å°±æ˜¯categoryçš„åå­—ç”¨æ¥ç»™å„ç§åˆ—è¡¨ä»¥åŠåé¢çš„categoryç»“æ„ä½“æœ¬èº«å‘½åï¼Œè€Œä¸”æœ‰staticæ¥ä¿®é¥°ï¼Œæ‰€ä»¥åœ¨åŒä¸€ä¸ªç¼–è¯‘å•å…ƒé‡Œæˆ‘ä»¬çš„categoryåä¸èƒ½é‡å¤ï¼Œå¦åˆ™ä¼šå‡ºç°ç¼–è¯‘é”™è¯¯ã€‚
    <ul>
      <li>å…¶æ¬¡ï¼Œç¼–è¯‘å™¨ç”Ÿæˆäº†categoryæœ¬èº«OBJC$_CATEGORYMyClass$_MyAdditionï¼Œå¹¶ç”¨å‰é¢ç”Ÿæˆçš„åˆ—è¡¨æ¥åˆå§‹åŒ–categoryæœ¬èº«ã€‚</li>
      <li>æœ€åï¼Œç¼–è¯‘å™¨åœ¨DATAæ®µä¸‹çš„objc_catlist sectioné‡Œä¿å­˜äº†ä¸€ä¸ªå¤§å°ä¸º1çš„category_tçš„æ•°ç»„L_OBJC_LABELCATEGORY$ï¼ˆå½“ç„¶ï¼Œå¦‚æœæœ‰å¤šä¸ªcategoryï¼Œä¼šç”Ÿæˆå¯¹åº”é•¿åº¦çš„æ•°ç»„^_^ï¼‰ï¼Œç”¨äºè¿è¡ŒæœŸcategoryçš„åŠ è½½ã€‚
åˆ°è¿™é‡Œï¼Œç¼–è¯‘å™¨çš„å·¥ä½œå°±æ¥è¿‘å°¾å£°äº†ï¼Œå¯¹äºcategoryåœ¨è¿è¡ŒæœŸæ€ä¹ˆåŠ è½½ï¼Œæˆ‘ä»¬ä¸‹èŠ‚æ­æ™“ã€‚</li>
    </ul>
  </li>
</ol>

<h2 id="è¿½æœ¬æº¯æº-categoryå¦‚ä½•åŠ è½½">è¿½æœ¬æº¯æº categoryå¦‚ä½•åŠ è½½</h2>

<p>æˆ‘ä»¬çŸ¥é“ï¼ŒObjective-Cçš„è¿è¡Œæ˜¯ä¾èµ–OCçš„runtimeçš„ï¼Œè€ŒOCçš„runtimeå’Œå…¶ä»–ç³»ç»Ÿåº“ä¸€æ ·ï¼Œæ˜¯OS Xå’ŒiOSé€šè¿‡dyldåŠ¨æ€åŠ è½½çš„ã€‚
æƒ³äº†è§£æ›´å¤šdyldåœ°åŒå­¦å¯ä»¥ç§»æ­¥<a href="https://www.mikeash.com/pyblog/friday-qa-2012-11-09-dyld-dynamic-linking-on-os-x.html">è¿™é‡Œ</a>ã€‚</p>

<p>å¯¹äºOCè¿è¡Œæ—¶ï¼Œå…¥å£æ–¹æ³•å¦‚ä¸‹ï¼ˆåœ¨objc-os.mmæ–‡ä»¶ä¸­ï¼‰ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>void _objc_init(void)
{
    static bool initialized = false;
    if (initialized) return;
    initialized = true;

    // fixme defer initialization until an objc-using image is found?
    environ_init();
    tls_init();
    lock_init();
    exception_init();

    // Register for unmap first, in case some +load unmaps something
    _dyld_register_func_for_remove_image(&amp;unmap_image);
    dyld_register_image_state_change_handler(dyld_image_state_bound,
                                             1/*batch*/, &amp;map_images);
    dyld_register_image_state_change_handler(dyld_image_state_dependents_initialized, 0/*not batch*/, &amp;load_images);
}
</code></pre></div></div>
<p>categoryè¢«é™„åŠ åˆ°ç±»ä¸Šé¢æ˜¯åœ¨map_imagesçš„æ—¶å€™å‘ç”Ÿçš„ï¼Œåœ¨new-ABIçš„æ ‡å‡†ä¸‹ï¼Œ_objc_inité‡Œé¢çš„è°ƒç”¨çš„map_imagesæœ€ç»ˆä¼šè°ƒç”¨objc-runtime-new.mmé‡Œé¢çš„_read_imagesæ–¹æ³•ï¼Œè€Œåœ¨_read_imagesæ–¹æ³•çš„ç»“å°¾ï¼Œæœ‰ä»¥ä¸‹çš„ä»£ç ç‰‡æ®µï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// Discover categories. 
    for (EACH_HEADER) {
        category_t **catlist =
            _getObjc2CategoryList(hi, &amp;count);
        for (i = 0; i &lt; count; i++) {
            category_t *cat = catlist[i];
            class_t *cls = remapClass(cat-&gt;cls);

            if (!cls) {
                // Category's target class is missing (probably weak-linked).
                // Disavow any knowledge of this category.
                catlist[i] = NULL;
                if (PrintConnecting) {
                    _objc_inform("CLASS: IGNORING category \?\?\?(%s) %p with "
                                 "missing weak-linked target class",
                                 cat-&gt;name, cat);
                }
                continue;
            }

            // Process this category. 
            // First, register the category with its target class. 
            // Then, rebuild the class's method lists (etc) if 
            // the class is realized. 
            BOOL classExists = NO;
            if (cat-&gt;instanceMethods ||  cat-&gt;protocols 
                ||  cat-&gt;instanceProperties)
            {
                addUnattachedCategoryForClass(cat, cls, hi);
                if (isRealized(cls)) {
                    remethodizeClass(cls);
                    classExists = YES;
                }
                if (PrintConnecting) {
                    _objc_inform("CLASS: found category -%s(%s) %s",
                                 getName(cls), cat-&gt;name,
                                 classExists ? "on existing class" : "");
                }
            }

            if (cat-&gt;classMethods  ||  cat-&gt;protocols 
                /* ||  cat-&gt;classProperties */)
            {
                addUnattachedCategoryForClass(cat, cls-&gt;isa, hi);
                if (isRealized(cls-&gt;isa)) {
                    remethodizeClass(cls-&gt;isa);
                }
                if (PrintConnecting) {
                    _objc_inform("CLASS: found category +%s(%s)",
                                 getName(cls), cat-&gt;name);
                }
            }
        }
    }
</code></pre></div></div>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬æ‹¿åˆ°çš„catlistå°±æ˜¯ä¸ŠèŠ‚ä¸­è®²åˆ°çš„ç¼–è¯‘å™¨ä¸ºæˆ‘ä»¬å‡†å¤‡çš„category_tæ•°ç»„ï¼Œå…³äºæ˜¯å¦‚ä½•åŠ è½½catlistæœ¬èº«çš„ï¼Œæˆ‘ä»¬æš‚ä¸”ä¸è¡¨ï¼Œè¿™å’Œcategoryæœ¬èº«çš„å…³ç³»ä¹Ÿä¸å¤§ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥å»ç ”ç©¶ä»¥ä¸‹Appleçš„äºŒè¿›åˆ¶æ ¼å¼å’Œloadæœºåˆ¶ã€‚</p>

<p>ç•¥å»PrintConnectingè¿™ä¸ªç”¨äºlogçš„ä¸œè¥¿ï¼Œè¿™æ®µä»£ç å¾ˆå®¹æ˜“ç†è§£ï¼š</p>

<ol>
  <li>æŠŠcategoryçš„å®ä¾‹æ–¹æ³•ã€åè®®ä»¥åŠå±æ€§æ·»åŠ åˆ°ç±»ä¸Š</li>
  <li>æŠŠcategoryçš„ç±»æ–¹æ³•å’Œåè®®æ·»åŠ åˆ°ç±»çš„metaclassä¸Š</li>
</ol>

<p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œåœ¨ä»£ç ä¸­æœ‰ä¸€å°æ®µæ³¨é‡Š <code class="language-plaintext highlighter-rouge">/ || cat-&gt;classProperties /</code>ï¼Œçœ‹æ¥è‹¹æœæœ‰è¿‡ç»™ç±»æ·»åŠ å±æ€§çš„è®¡åˆ’å•Šã€‚
okï¼Œæˆ‘ä»¬æ¥ç€å¾€é‡Œçœ‹ï¼Œcategoryçš„å„ç§åˆ—è¡¨æ˜¯æ€ä¹ˆæœ€ç»ˆæ·»åŠ åˆ°ç±»ä¸Šçš„ï¼Œå°±æ‹¿å®ä¾‹æ–¹æ³•åˆ—è¡¨æ¥è¯´å§ï¼š
åœ¨ä¸Šè¿°çš„ä»£ç ç‰‡æ®µé‡Œï¼ŒaddUnattachedCategoryForClassåªæ˜¯æŠŠç±»å’Œcategoryåšä¸€ä¸ªå…³è”æ˜ å°„ï¼Œè€ŒremethodizeClassæ‰æ˜¯çœŸæ­£å»å¤„ç†æ·»åŠ äº‹å®œçš„åŠŸè‡£ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>static void remethodizeClass(class_t *cls)
{
    category_list *cats;
    BOOL isMeta;

    rwlock_assert_writing(&amp;runtimeLock);

    isMeta = isMetaClass(cls);

    // Re-methodizing: check for more categories
    if ((cats = unattachedCategoriesForClass(cls))) {
        chained_property_list *newproperties;
        const protocol_list_t **newprotos;

        if (PrintConnecting) {
            _objc_inform("CLASS: attaching categories to class '%s' %s",
                         getName(cls), isMeta ? "(meta)" : "");
        }

        // Update methods, properties, protocols

        BOOL vtableAffected = NO;
        attachCategoryMethods(cls, cats, &amp;vtableAffected);

        newproperties = buildPropertyList(NULL, cats, isMeta);
        if (newproperties) {
            newproperties-&gt;next = cls-&gt;data()-&gt;properties;
            cls-&gt;data()-&gt;properties = newproperties;
        }

        newprotos = buildProtocolList(cats, NULL, cls-&gt;data()-&gt;protocols);
        if (cls-&gt;data()-&gt;protocols  &amp;&amp;  cls-&gt;data()-&gt;protocols != newprotos) {
            _free_internal(cls-&gt;data()-&gt;protocols);
        }
        cls-&gt;data()-&gt;protocols = newprotos;

        _free_internal(cats);

        // Update method caches and vtables
        flushCaches(cls);
        if (vtableAffected) flushVtables(cls);
    }
}
</code></pre></div></div>
<p>è€Œå¯¹äºæ·»åŠ ç±»çš„å®ä¾‹æ–¹æ³•è€Œè¨€ï¼Œåˆä¼šå»è°ƒç”¨attachCategoryMethodsè¿™ä¸ªæ–¹æ³•ï¼Œæˆ‘ä»¬å»çœ‹ä¸‹attachCategoryMethodsï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>static void 
attachCategoryMethods(class_t *cls, category_list *cats,
                      BOOL *inoutVtablesAffected)
{
    if (!cats) return;
    if (PrintReplacedMethods) printReplacements(cls, cats);

    BOOL isMeta = isMetaClass(cls);
    method_list_t **mlists = (method_list_t **)
        _malloc_internal(cats-&gt;count * sizeof(*mlists));

    // Count backwards through cats to get newest categories first
    int mcount = 0;
    int i = cats-&gt;count;
    BOOL fromBundle = NO;
    while (i--) {
        method_list_t *mlist = cat_method_list(cats-&gt;list[i].cat, isMeta);
        if (mlist) {
            mlists[mcount++] = mlist;
            fromBundle |= cats-&gt;list[i].fromBundle;
        }
    }

    attachMethodLists(cls, mlists, mcount, NO, fromBundle, inoutVtablesAffected);

    _free_internal(mlists);

}

</code></pre></div></div>
<p>attachCategoryMethodsåšçš„å·¥ä½œç›¸å¯¹æ¯”è¾ƒç®€å•ï¼Œå®ƒåªæ˜¯æŠŠæ‰€æœ‰categoryçš„å®ä¾‹æ–¹æ³•åˆ—è¡¨æ‹¼æˆäº†ä¸€ä¸ªå¤§çš„å®ä¾‹æ–¹æ³•åˆ—è¡¨ï¼Œç„¶åè½¬äº¤ç»™äº†attachMethodListsæ–¹æ³•ï¼ˆæˆ‘å‘èª“ï¼Œè¿™æ˜¯æœ¬èŠ‚æˆ‘ä»¬çœ‹çš„æœ€åä¸€æ®µä»£ç äº†^_^ï¼‰ï¼Œè¿™ä¸ªæ–¹æ³•æœ‰ç‚¹é•¿ï¼Œæˆ‘ä»¬åªçœ‹ä¸€å°æ®µï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>for (uint32_t m = 0;
             (scanForCustomRR || scanForCustomAWZ)  &amp;&amp;  m &lt; mlist-&gt;count;
             m++)
        {
            SEL sel = method_list_nth(mlist, m)-&gt;name;
            if (scanForCustomRR  &amp;&amp;  isRRSelector(sel)) {
                cls-&gt;setHasCustomRR();
                scanForCustomRR = false;
            } else if (scanForCustomAWZ  &amp;&amp;  isAWZSelector(sel)) {
                cls-&gt;setHasCustomAWZ();
                scanForCustomAWZ = false;
            }
        }

        // Fill method list array
        newLists[newCount++] = mlist;
    .
    .
    .

    // Copy old methods to the method list array
    for (i = 0; i &lt; oldCount; i++) {
        newLists[newCount++] = oldLists[i];
    }
</code></pre></div></div>
<p>éœ€è¦æ³¨æ„çš„æœ‰ä¸¤ç‚¹ï¼š</p>

<ol>
  <li>categoryçš„æ–¹æ³•æ²¡æœ‰â€œå®Œå…¨æ›¿æ¢æ‰â€åŸæ¥ç±»å·²ç»æœ‰çš„æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœcategoryå’ŒåŸæ¥ç±»éƒ½æœ‰methodAï¼Œé‚£ä¹ˆcategoryé™„åŠ å®Œæˆä¹‹åï¼Œç±»çš„æ–¹æ³•åˆ—è¡¨é‡Œä¼šæœ‰ä¸¤ä¸ªmethodA</li>
  <li>categoryçš„æ–¹æ³•è¢«æ”¾åˆ°äº†æ–°æ–¹æ³•åˆ—è¡¨çš„å‰é¢ï¼Œè€ŒåŸæ¥ç±»çš„æ–¹æ³•è¢«æ”¾åˆ°äº†æ–°æ–¹æ³•åˆ—è¡¨çš„åé¢ï¼Œè¿™ä¹Ÿå°±æ˜¯æˆ‘ä»¬å¹³å¸¸æ‰€è¯´çš„categoryçš„æ–¹æ³•ä¼šâ€œè¦†ç›–â€æ‰åŸæ¥ç±»çš„åŒåæ–¹æ³•ï¼Œè¿™æ˜¯å› ä¸ºè¿è¡Œæ—¶åœ¨æŸ¥æ‰¾æ–¹æ³•çš„æ—¶å€™æ˜¯é¡ºç€æ–¹æ³•åˆ—è¡¨çš„é¡ºåºæŸ¥æ‰¾çš„ï¼Œå®ƒåªè¦ä¸€æ‰¾åˆ°å¯¹åº”åå­—çš„æ–¹æ³•ï¼Œå°±ä¼šç½¢ä¼‘^_^ï¼Œæ®Šä¸çŸ¥åé¢å¯èƒ½è¿˜æœ‰ä¸€æ ·åå­—çš„æ–¹æ³•ã€‚</li>
</ol>

<h2 id="æ—ææœ«å¶-category-å’Œ-load-æ–¹æ³•">æ—ææœ«å¶ category å’Œ +load æ–¹æ³•</h2>

<p>æˆ‘ä»¬çŸ¥é“ï¼Œåœ¨ç±»å’Œcategoryä¸­éƒ½å¯ä»¥æœ‰+loadæ–¹æ³•ï¼Œé‚£ä¹ˆæœ‰ä¸¤ä¸ªé—®é¢˜ï¼š</p>

<ol>
  <li>åœ¨ç±»çš„+loadæ–¹æ³•è°ƒç”¨çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥è°ƒç”¨categoryä¸­å£°æ˜çš„æ–¹æ³•ä¹ˆï¼Ÿ</li>
  <li>è¿™ä¹ˆäº›ä¸ª+loadæ–¹æ³•ï¼Œè°ƒç”¨é¡ºåºæ˜¯å’‹æ ·çš„å‘¢ï¼Ÿ</li>
</ol>

<p>é‰´äºä¸Šè¿°å‡ èŠ‚æˆ‘ä»¬çœ‹çš„ä»£ç å¤ªå¤šäº†ï¼Œå¯¹äºè¿™ä¸¤ä¸ªé—®é¢˜æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ç‚¹ç›´è§‚çš„ï¼š</p>

<p><img src="http://tech.meituan.com/img/diveintocategory/project.png" alt="" /></p>

<p>æˆ‘ä»¬çš„ä»£ç é‡Œæœ‰MyClasså’ŒMyClassçš„ä¸¤ä¸ªcategory ï¼ˆCategory1å’ŒCategory2ï¼‰ï¼ŒMyClasså’Œä¸¤ä¸ªcategoryéƒ½æ·»åŠ äº†+loadæ–¹æ³•ï¼Œå¹¶ä¸”Category1å’ŒCategory2éƒ½å†™äº†MyClassçš„printNameæ–¹æ³•ã€‚
åœ¨Xcodeä¸­ç‚¹å‡»Edit Schemeï¼Œæ·»åŠ å¦‚ä¸‹ä¸¤ä¸ªç¯å¢ƒå˜é‡ï¼ˆå¯ä»¥åœ¨æ‰§è¡Œloadæ–¹æ³•ä»¥åŠåŠ è½½categoryçš„æ—¶å€™æ‰“å°logä¿¡æ¯ï¼Œæ›´å¤šçš„ç¯å¢ƒå˜é‡é€‰é¡¹å¯å‚è§objc-private.hï¼‰:
<img src="http://tech.meituan.com/img/diveintocategory/environment_vars.png" alt="" /></p>

<p>è¿è¡Œé¡¹ç›®ï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°æ§åˆ¶å°æ‰“å°å¾ˆå¤šä¸œè¥¿å‡ºæ¥ï¼Œæˆ‘ä»¬åªæ‰¾åˆ°æˆ‘ä»¬æƒ³è¦çš„ä¿¡æ¯ï¼Œé¡ºåºå¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>objc[1187]: REPLACED: -[MyClass printName] by category Category1
objc[1187]: REPLACED: -[MyClass printName] by category Category2
.
.
.
objc[1187]: LOAD: class 'MyClass' scheduled for +load
objc[1187]: LOAD: category 'MyClass(Category1)' scheduled for +load
objc[1187]: LOAD: category 'MyClass(Category2)' scheduled for +load
objc[1187]: LOAD: +[MyClass load]
.
.
.
objc[1187]: LOAD: +[MyClass(Category1) load]
.
.
.
objc[1187]: LOAD: +[MyClass(Category2) load]
</code></pre></div></div>

<p>æ‰€ä»¥ï¼Œå¯¹äºä¸Šé¢ä¸¤ä¸ªé—®é¢˜ï¼Œç­”æ¡ˆæ˜¯å¾ˆæ˜æ˜¾çš„ï¼š</p>

<ol>
  <li>å¯ä»¥è°ƒç”¨ï¼Œå› ä¸ºé™„åŠ categoryåˆ°ç±»çš„å·¥ä½œä¼šå…ˆäº+loadæ–¹æ³•çš„æ‰§è¡Œ
    <ul>
      <li>+loadçš„æ‰§è¡Œé¡ºåºæ˜¯å…ˆç±»ï¼Œåcategoryï¼Œè€Œcategoryçš„+loadæ‰§è¡Œé¡ºåºæ˜¯æ ¹æ®ç¼–è¯‘é¡ºåºå†³å®šçš„ã€‚
ç›®å‰çš„ç¼–è¯‘é¡ºåºæ˜¯è¿™æ ·çš„ï¼š</li>
    </ul>
  </li>
</ol>

<p><img src="http://tech.meituan.com/img/diveintocategory/compile1.png" alt="" /></p>

<p>æˆ‘ä»¬è°ƒæ•´ä¸€ä¸ªCategory1å’ŒCategory2çš„ç¼–è¯‘é¡ºåºï¼Œrunã€‚okï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ§åˆ¶å°çš„è¾“å‡ºé¡ºåºå˜äº†ï¼š</p>

<p><img src="http://tech.meituan.com/img/diveintocategory/compile2.png" alt="" /></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>objc[1187]: REPLACED: -[MyClass printName] by category Category2
objc[1187]: REPLACED: -[MyClass printName] by category Category1
.
.
.
objc[1187]: LOAD: class 'MyClass' scheduled for +load
objc[1187]: LOAD: category 'MyClass(Category2)' scheduled for +load
objc[1187]: LOAD: category 'MyClass(Category1)' scheduled for +load
objc[1187]: LOAD: +[MyClass load]
.
.
.
objc[1187]: LOAD: +[MyClass(Category2) load]
.
.
.
objc[1187]: LOAD: +[MyClass(Category1) load]
</code></pre></div></div>

<p>è™½ç„¶å¯¹äº+loadçš„æ‰§è¡Œé¡ºåºæ˜¯è¿™æ ·ï¼Œä½†æ˜¯å¯¹äºâ€œè¦†ç›–â€æ‰çš„æ–¹æ³•ï¼Œåˆ™ä¼šå…ˆæ‰¾åˆ°æœ€åä¸€ä¸ªç¼–è¯‘çš„categoryé‡Œçš„å¯¹åº”æ–¹æ³•ã€‚</p>

<p>è¿™ä¸€èŠ‚æˆ‘ä»¬åªæ˜¯ç”¨å¾ˆç›´è§‚çš„æ–¹å¼å¾—åˆ°äº†é—®é¢˜çš„ç­”æ¡ˆï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥ç»§ç»­å»ç ”ç©¶ä¸€ä¸‹OCçš„è¿è¡Œæ—¶ä»£ç ã€‚</p>

<h2 id="è§¦ç±»æ—é€š-category-å’Œæ–¹æ³•è¦†ç›–">è§¦ç±»æ—é€š category å’Œæ–¹æ³•è¦†ç›–</h2>

<p>é‰´äºä¸Šé¢å‡ èŠ‚æˆ‘ä»¬å·²ç»æŠŠåŸç†éƒ½è®²äº†ï¼Œè¿™ä¸€èŠ‚åªæœ‰ä¸€ä¸ªé—®é¢˜:</p>

<p>æ€ä¹ˆè°ƒç”¨åˆ°åŸæ¥ç±»ä¸­è¢«categoryè¦†ç›–æ‰çš„æ–¹æ³•ï¼Ÿ</p>

<p>å¯¹äºè¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å·²ç»çŸ¥é“categoryå…¶å®å¹¶ä¸æ˜¯å®Œå…¨æ›¿æ¢æ‰åŸæ¥ç±»çš„åŒåæ–¹æ³•ï¼Œåªæ˜¯categoryåœ¨æ–¹æ³•åˆ—è¡¨çš„å‰é¢è€Œå·²ï¼Œæ‰€ä»¥æˆ‘ä»¬åªè¦é¡ºç€æ–¹æ³•åˆ—è¡¨æ‰¾åˆ°æœ€åä¸€ä¸ªå¯¹åº”åå­—çš„æ–¹æ³•ï¼Œå°±å¯ä»¥è°ƒç”¨åŸæ¥ç±»çš„æ–¹æ³•ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Class currentClass = [MyClass class];
MyClass *my = [[MyClass alloc] init];

if (currentClass) {
    unsigned int methodCount;
    Method *methodList = class_copyMethodList(currentClass, &amp;methodCount);
    IMP lastImp = NULL;
    SEL lastSel = NULL;
    for (NSInteger i = 0; i &lt; methodCount; i++) {
        Method method = methodList[i];
        NSString *methodName = [NSString stringWithCString:sel_getName(method_getName(method)) 
                                        encoding:NSUTF8StringEncoding];
        if ([@"printName" isEqualToString:methodName]) {
            lastImp = method_getImplementation(method);
            lastSel = method_getName(method);
        }
    }
    typedef void (*fn)(id,SEL);

    if (lastImp != NULL) {
        fn f = (fn)lastImp;
        f(my,lastSel);
    }
    free(methodList);
}
</code></pre></div></div>

<h2 id="æ›´ä¸Šä¸€å±‚-category-å’Œå…³è”å¯¹è±¡">æ›´ä¸Šä¸€å±‚ category å’Œå…³è”å¯¹è±¡</h2>

<p>å¦‚ä¸Šæ‰€è§ï¼Œæˆ‘ä»¬çŸ¥é“åœ¨categoryé‡Œé¢æ˜¯æ— æ³•ä¸ºcategoryæ·»åŠ å®ä¾‹å˜é‡çš„ã€‚ä½†æ˜¯æˆ‘ä»¬å¾ˆå¤šæ—¶å€™éœ€è¦åœ¨categoryä¸­æ·»åŠ å’Œå¯¹è±¡å…³è”çš„å€¼ï¼Œè¿™ä¸ªæ—¶å€™å¯ä»¥æ±‚åŠ©å…³è”å¯¹è±¡æ¥å®ç°ã€‚</p>

<p>MyClass+Category1.h:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#import "MyClass.h"

@interface MyClass (Category1)

@property(nonatomic,copy) NSString *name;

@end
</code></pre></div></div>

<p>MyClass+Category1.m:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#import "MyClass+Category1.h"
#import &lt;objc/runtime.h&gt;

@implementation MyClass (Category1)

+ (void)load
{
    NSLog(@"%@",@"load in Category1");
}

- (void)setName:(NSString *)name
{
    objc_setAssociatedObject(self,
                             "name",
                             name,
                             OBJC_ASSOCIATION_COPY);
}

- (NSString*)name
{
    NSString *nameObject = objc_getAssociatedObject(self, "name");
    return nameObject;
}

@end
</code></pre></div></div>

<p>ä½†æ˜¯å…³è”å¯¹è±¡åˆæ˜¯å­˜åœ¨ä»€ä¹ˆåœ°æ–¹å‘¢ï¼Ÿ å¦‚ä½•å­˜å‚¨ï¼Ÿ å¯¹è±¡é”€æ¯æ—¶å€™å¦‚ä½•å¤„ç†å…³è”å¯¹è±¡å‘¢ï¼Ÿ
æˆ‘ä»¬å»ç¿»ä¸€ä¸‹runtimeçš„æºç ï¼Œåœ¨objc-references.mmæ–‡ä»¶ä¸­æœ‰ä¸ªæ–¹æ³•_object_set_associative_referenceï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>void _object_set_associative_reference(id object, void *key, id value, uintptr_t policy) {
    // retain the new value (if any) outside the lock.
    ObjcAssociation old_association(0, nil);
    id new_value = value ? acquireValue(value, policy) : nil;
    {
        AssociationsManager manager;
        AssociationsHashMap &amp;associations(manager.associations());
        disguised_ptr_t disguised_object = DISGUISE(object);
        if (new_value) {
            // break any existing association.
            AssociationsHashMap::iterator i = associations.find(disguised_object);
            if (i != associations.end()) {
                // secondary table exists
                ObjectAssociationMap *refs = i-&gt;second;
                ObjectAssociationMap::iterator j = refs-&gt;find(key);
                if (j != refs-&gt;end()) {
                    old_association = j-&gt;second;
                    j-&gt;second = ObjcAssociation(policy, new_value);
                } else {
                    (*refs)[key] = ObjcAssociation(policy, new_value);
                }
            } else {
                // create the new association (first time).
                ObjectAssociationMap *refs = new ObjectAssociationMap;
                associations[disguised_object] = refs;
                (*refs)[key] = ObjcAssociation(policy, new_value);
                _class_setInstancesHaveAssociatedObjects(_object_getClass(object));
            }
        } else {
            // setting the association to nil breaks the association.
            AssociationsHashMap::iterator i = associations.find(disguised_object);
            if (i !=  associations.end()) {
                ObjectAssociationMap *refs = i-&gt;second;
                ObjectAssociationMap::iterator j = refs-&gt;find(key);
                if (j != refs-&gt;end()) {
                    old_association = j-&gt;second;
                    refs-&gt;erase(j);
                }
            }
        }
    }
    // release the old value (outside of the lock).
    if (old_association.hasValue()) ReleaseValue()(old_association);
}
</code></pre></div></div>

<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ‰€æœ‰çš„å…³è”å¯¹è±¡éƒ½ç”±AssociationsManagerç®¡ç†ï¼Œè€ŒAssociationsManagerå®šä¹‰å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class AssociationsManager {
    static OSSpinLock _lock;
    static AssociationsHashMap *_map;               // associative references:  object pointer -&gt; PtrPtrHashMap.
public:
    AssociationsManager()   { OSSpinLockLock(&amp;_lock); }
    ~AssociationsManager()  { OSSpinLockUnlock(&amp;_lock); }

    AssociationsHashMap &amp;associations() {
        if (_map == NULL)
            _map = new AssociationsHashMap();
        return *_map;
    }
};
</code></pre></div></div>

<p>AssociationsManageré‡Œé¢æ˜¯ç”±ä¸€ä¸ªé™æ€AssociationsHashMapæ¥å­˜å‚¨æ‰€æœ‰çš„å…³è”å¯¹è±¡çš„ã€‚è¿™ç›¸å½“äºæŠŠæ‰€æœ‰å¯¹è±¡çš„å…³è”å¯¹è±¡éƒ½å­˜åœ¨ä¸€ä¸ªå…¨å±€mapé‡Œé¢ã€‚è€Œmapçš„çš„keyæ˜¯è¿™ä¸ªå¯¹è±¡çš„æŒ‡é’ˆåœ°å€ï¼ˆä»»æ„ä¸¤ä¸ªä¸åŒå¯¹è±¡çš„æŒ‡é’ˆåœ°å€ä¸€å®šæ˜¯ä¸åŒçš„ï¼‰ï¼Œè€Œè¿™ä¸ªmapçš„valueåˆæ˜¯å¦å¤–ä¸€ä¸ªAssociationsHashMapï¼Œé‡Œé¢ä¿å­˜äº†å…³è”å¯¹è±¡çš„kvå¯¹ã€‚
è€Œåœ¨å¯¹è±¡çš„é”€æ¯é€»è¾‘é‡Œé¢ï¼Œè§objc-runtime-new.mm:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>void *objc_destructInstance(id obj) 
{
    if (obj) {
        Class isa_gen = _object_getClass(obj);
        class_t *isa = newcls(isa_gen);

        // Read all of the flags at once for performance.
        bool cxx = hasCxxStructors(isa);
        bool assoc = !UseGC &amp;&amp; _class_instancesHaveAssociatedObjects(isa_gen);

        // This order is important.
        if (cxx) object_cxxDestruct(obj);
        if (assoc) _object_remove_assocations(obj);

        if (!UseGC) objc_clear_deallocating(obj);
    }

    return obj;
}
</code></pre></div></div>

<p>å—¯ï¼Œruntimeçš„é”€æ¯å¯¹è±¡å‡½æ•°objc_destructInstanceé‡Œé¢ä¼šåˆ¤æ–­è¿™ä¸ªå¯¹è±¡æœ‰æ²¡æœ‰å…³è”å¯¹è±¡ï¼Œå¦‚æœæœ‰ï¼Œä¼šè°ƒç”¨_object_remove_assocationsåšå…³è”å¯¹è±¡çš„æ¸…ç†å·¥ä½œã€‚</p>

<h1 id="åè®°">åè®°</h1>

<p>æ­£å¦‚ä¾¯æ·å…ˆç”Ÿæ‰€è®²-â€œæºç é¢å‰ï¼Œäº†æ— ç§˜å¯†â€ï¼ŒAppleçš„Cocoa Touchæ¡†æ¶è™½ç„¶å¹¶ä¸å¼€æºï¼Œä½†æ˜¯Objective-Cçš„runtimeå’ŒCore Foundationå´æ˜¯å®Œå…¨å¼€æ”¾æºç çš„(åœ¨<a href="http://www.opensource.apple.com/tarballs/">http://www.opensource.apple.com/tarballs/</a>å¯ä»¥ä¸‹è½½åˆ°å…¨éƒ¨çš„å¼€æºä»£ç )ã€‚
æœ¬ç³»åˆ—runtimeæºç å­¦ä¹ å°†ä¼šæŒç»­æ›´æ–°ï¼Œæ„çŠ¹æœªå°½çš„åŒå­¦å¯ä»¥è‡ªè¡Œåˆ°ä¸Šè¿°ç½‘ç«™ä¸‹è½½æºç å­¦ä¹ ã€‚è¡Œç¬”ç®€é™‹ï¼Œå¦‚æœ‰é”™è¯¯ï¼Œæœ›æŒ‡æ­£ã€‚</p>
:ET