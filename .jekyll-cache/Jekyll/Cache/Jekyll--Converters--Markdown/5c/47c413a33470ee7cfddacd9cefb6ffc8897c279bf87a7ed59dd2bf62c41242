I"ç<h2 id="å‰è¨€">å‰è¨€</h2>

<p>è¿™ç¯‡åšå®¢ä¹æœˆå°±æƒ³å†™äº†ï¼Œå› ä¸ºèµ¶é¡¹ç›®æ‹–äº†åˆ°ç°åœ¨ï¼ŒæŠ“ä½17å¹´å°¾å·´å†™å§~</p>

<h2 id="æ­£æ–‡">æ­£æ–‡</h2>

<p>ä¸Šæ¬¡çœ‹äº†ä¸€ç¯‡ <a href="https://www.jianshu.com/p/cec2a41aa0e7">ã€Šä»ä¸€é“ç½‘æ˜“é¢è¯•é¢˜æµ…è°ˆOCçº¿ç¨‹å®‰å…¨ã€‹</a> çš„åšå®¢ï¼Œä¸»è¦å†…å®¹æ˜¯ï¼š</p>

<p>ä½œè€…å»ç½‘æ˜“é¢è¯•ï¼Œé¢è¯•å®˜å‡ºäº†ä¸€é“é¢è¯•é¢˜ï¼šä¸‹é¢ä»£ç ä¼šå‘ç”Ÿä»€ä¹ˆé—®é¢˜ï¼Ÿ</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span> <span class="n">NSString</span> <span class="o">*</span><span class="n">target</span><span class="p">;</span>
<span class="c1">//....</span>
<span class="n">dispatch_queue_t</span> <span class="n">queue</span> <span class="o">=</span> <span class="n">dispatch_queue_create</span><span class="p">(</span><span class="s">"parallel"</span><span class="p">,</span> <span class="n">DISPATCH_QUEUE_CONCURRENT</span><span class="p">);</span>
<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">1000000</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">dispatch_async</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="o">^</span><span class="p">{</span>
        <span class="n">self</span><span class="p">.</span><span class="n">target</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSString</span> <span class="nf">stringWithFormat</span><span class="p">:</span><span class="s">@"ksddkjalkjd%d"</span><span class="p">,</span><span class="n">i</span><span class="p">];</span>
    <span class="p">});</span>
<span class="p">}</span>
</code></pre></div></div>

<p>ç­”æ¡ˆæ˜¯ï¼šä¼š crashã€‚</p>

<p>æˆ‘ä»¬æ¥çœ‹çœ‹å¯¹<code class="language-plaintext highlighter-rouge">target</code>å±æ€§ï¼ˆ<code class="language-plaintext highlighter-rouge">strong</code>ä¿®é¥°ï¼‰è¿›è¡Œèµ‹å€¼ï¼Œç›¸å½“ä¸ MRC ä¸­çš„</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- (void)setTarget:(NSString *)target {
    if (target == _target) return;
    id pre = _target;
    [target retain];//1.å…ˆä¿ç•™æ–°å€¼
    _target = target;//2.å†è¿›è¡Œèµ‹å€¼
    [pre release];//3.é‡Šæ”¾æ—§å€¼
}
</code></pre></div></div>

<p>å› ä¸ºåœ¨ <em>å¹¶è¡Œé˜Ÿåˆ—</em> <code class="language-plaintext highlighter-rouge">DISPATCH_QUEUE_CONCURRENT</code> ä¸­<em>å¼‚æ­¥</em> <code class="language-plaintext highlighter-rouge">dispatch_async</code> å¯¹ <code class="language-plaintext highlighter-rouge">target</code>å±æ€§è¿›è¡Œèµ‹å€¼ï¼Œå°±ä¼šå¯¼è‡´ target å·²ç»è¢« <code class="language-plaintext highlighter-rouge">release</code>äº†ï¼Œè¿˜ä¼šæ‰§è¡Œ <code class="language-plaintext highlighter-rouge">release</code>ã€‚è¿™å°±æ˜¯å‘å·²é‡Šæ”¾å†…å­˜å¯¹è±¡å‘é€æ¶ˆæ¯è€Œå‘ç”Ÿ crash ã€‚</p>

<h3 id="ä½†æ˜¯">ä½†æ˜¯</h3>

<p>æˆ‘æ•²äº†è¿™æ®µä»£ç ï¼Œæ‰§è¡Œçš„æ—¶å€™å‘ç°å¹¶ä¸ä¼š crash~</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">strong</span><span class="p">)</span> <span class="n">NSString</span> <span class="o">*</span><span class="n">target</span><span class="p">;</span>
<span class="n">dispatch_queue_t</span> <span class="n">queue</span> <span class="o">=</span> <span class="n">dispatch_queue_create</span><span class="p">(</span><span class="s">"parallel"</span><span class="p">,</span> <span class="n">DISPATCH_QUEUE_CONCURRENT</span><span class="p">);</span>
<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">1000000</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">dispatch_async</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="o">^</span><span class="p">{</span>
    	<span class="c1">// â€˜ksddkjalkjdâ€™åˆ é™¤äº†</span>
        <span class="n">self</span><span class="p">.</span><span class="n">target</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSString</span> <span class="nf">stringWithFormat</span><span class="p">:</span><span class="s">@"%d"</span><span class="p">,</span><span class="n">i</span><span class="p">];</span>
    <span class="p">});</span>
<span class="p">}</span>
</code></pre></div></div>

<p>åŸå› å°±å‡ºåœ¨å¯¹ <code class="language-plaintext highlighter-rouge">self.target</code> èµ‹å€¼çš„å­—ç¬¦ä¸²ä¸Šã€‚åšå®¢çš„æœ€åä¹Ÿæåˆ°äº† - <em>â€˜ä¸Šè¿°ä»£ç çš„å­—ç¬¦ä¸²æ”¹çŸ­ä¸€äº›ï¼Œå°±ä¸ä¼šå´©æºƒâ€™</em>ï¼Œè¿˜æœ‰ <code class="language-plaintext highlighter-rouge">Tagged Pointer</code> è¿™ä¸ªä¸œè¥¿ã€‚</p>

<p>æˆ‘ä»¬å°†ä¸Šé¢çš„ä»£ç ä¿®æ”¹ä¸‹ï¼š</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">NSString</span> <span class="o">*</span><span class="n">str</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSString</span> <span class="nf">stringWithFormat</span><span class="p">:</span><span class="s">@"%d"</span><span class="p">,</span> <span class="n">i</span><span class="p">];</span>
<span class="n">NSLog</span><span class="p">(</span><span class="s">@"%d, %s, %p"</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">object_getClassName</span><span class="p">(</span><span class="n">str</span><span class="p">),</span> <span class="n">str</span><span class="p">);</span>
<span class="n">self</span><span class="p">.</span><span class="n">target</span> <span class="o">=</span> <span class="n">str</span><span class="p">;</span>
</code></pre></div></div>

<p>è¾“å‡ºï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0, NSTaggedPointerString, 0x3015
</code></pre></div></div>

<p>å‘ç°è¿™ä¸ªå­—ç¬¦ä¸²ç±»å‹æ˜¯ <code class="language-plaintext highlighter-rouge">NSTaggedPointerString</code>ï¼Œé‚£æˆ‘ä»¬æ¥çœ‹çœ‹ Tagged Pointer æ˜¯ä»€ä¹ˆï¼Ÿ</p>

<h3 id="tagged-pointer">Tagged Pointer</h3>

<p>Tagged Pointer è¯¦ç»†çš„å†…å®¹å¯ä»¥çœ‹è¿™é‡Œ <a href="http://www.infoq.com/cn/articles/deep-understanding-of-tagged-pointer">æ·±å…¥ç†è§£Tagged Pointer</a>ã€‚</p>

<p>Tagged Pointer æ˜¯ä¸€ä¸ªèƒ½å¤Ÿæå‡æ€§èƒ½ã€èŠ‚çœå†…å­˜çš„æœ‰è¶£çš„æŠ€æœ¯ã€‚</p>

<ul>
  <li>Tagged Pointer ä¸“é—¨ç”¨æ¥å­˜å‚¨å°çš„å¯¹è±¡ï¼Œä¾‹å¦‚ <strong>NSNumber</strong> å’Œ <strong>NSDate</strong>ï¼ˆåæ¥å¯ä»¥å­˜å‚¨å°å­—ç¬¦ä¸²ï¼‰</li>
  <li>Tagged Pointer æŒ‡é’ˆçš„å€¼ä¸å†æ˜¯åœ°å€äº†ï¼Œè€Œæ˜¯çœŸæ­£çš„å€¼ã€‚æ‰€ä»¥ï¼Œå®é™…ä¸Šå®ƒä¸å†æ˜¯ä¸€ä¸ªå¯¹è±¡äº†ï¼Œå®ƒåªæ˜¯ä¸€ä¸ªæŠ«ç€å¯¹è±¡çš®çš„æ™®é€šå˜é‡è€Œå·²ã€‚</li>
  <li>å®ƒçš„å†…å­˜å¹¶ä¸å­˜å‚¨åœ¨å †ä¸­ï¼Œä¹Ÿä¸éœ€è¦ malloc å’Œ freeï¼Œæ‰€ä»¥æ‹¥æœ‰æå¿«çš„è¯»å–å’Œåˆ›å»ºé€Ÿåº¦ã€‚</li>
</ul>

<h3 id="å‚è€ƒ">å‚è€ƒï¼š</h3>

<ul>
  <li>
    <p><a href="https://www.jianshu.com/p/cec2a41aa0e7">ä»ä¸€é“ç½‘æ˜“é¢è¯•é¢˜æµ…è°ˆOCçº¿ç¨‹å®‰å…¨</a></p>
  </li>
  <li>
    <p><a href="http://www.infoq.com/cn/articles/deep-understanding-of-tagged-pointer">æ·±å…¥ç†è§£Tagged Pointer</a></p>
  </li>
  <li>
    <p><a href="http://www.cocoachina.com/ios/20150918/13449.html">ã€è¯‘ã€‘é‡‡ç”¨Tagged Pointerçš„å­—ç¬¦ä¸²</a></p>
  </li>
</ul>

:ET