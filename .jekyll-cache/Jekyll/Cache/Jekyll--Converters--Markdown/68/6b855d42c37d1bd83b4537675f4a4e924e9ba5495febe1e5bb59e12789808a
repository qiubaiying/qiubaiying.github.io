I"›h<h1 id="å‰è¨€">å‰è¨€</h1>

<p>å®šæ—¶å™¨çš„ä½¿ç”¨æ˜¯è½¯ä»¶å¼€å‘åŸºç¡€æŠ€èƒ½ï¼Œç”¨äºå»¶æ—¶æ‰§è¡Œæˆ–é‡å¤æ‰§è¡ŒæŸäº›æ–¹æ³•ã€‚</p>

<p>æˆ‘ç›¸ä¿¡å¤§éƒ¨åˆ†äººæ¥è§¦iOSçš„å®šæ—¶å™¨éƒ½æ˜¯ä»è¿™æ®µä»£ç å¼€å§‹çš„:</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="n">NSTimer</span> <span class="nf">scheduledTimerWithTimeInterval</span><span class="p">:</span><span class="mi">1</span><span class="p">.</span><span class="mi">0</span> <span class="nf">target</span><span class="p">:</span><span class="n">self</span> <span class="n">selector</span><span class="o">:</span><span class="k">@selector</span><span class="p">(</span><span class="n">action</span><span class="o">:</span><span class="p">)</span> <span class="n">userInfo</span><span class="o">:</span><span class="nb">nil</span> <span class="n">repeats</span><span class="o">:</span><span class="nb">YES</span><span class="p">]</span>
</code></pre></div></div>

<p>ä½†æ˜¯ä½ çœŸçš„ä¼šç”¨å—ï¼Ÿ</p>

<h1 id="æ­£æ–‡">æ­£æ–‡</h1>

<h2 id="ioså®šæ—¶å™¨">iOSå®šæ—¶å™¨</h2>

<p>é¦–å…ˆæ¥ä»‹ç»iOSä¸­çš„å®šæ—¶å™¨</p>

<p>iOSä¸­çš„å®šæ—¶å™¨å¤§è‡´åˆ†ä¸ºè¿™å‡ ç±»ï¼š</p>

<ul>
  <li><strong>NSTimer</strong></li>
  <li><strong>CADisplayLink</strong></li>
  <li><strong>GCDå®šæ—¶å™¨</strong></li>
</ul>

<h3 id="nstimer">NSTimer</h3>

<h4 id="ä½¿ç”¨æ–¹æ³•">ä½¿ç”¨æ–¹æ³•</h4>

<p><strong>NSTime</strong>å®šæ—¶å™¨æ˜¯æˆ‘ä»¬æ¯”è¾ƒå¸¸ä½¿ç”¨çš„å®šæ—¶å™¨ï¼Œæ¯”è¾ƒå¸¸ä½¿ç”¨çš„æ–¹æ³•æœ‰ä¸¤ç§ï¼š</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">+</span> <span class="p">(</span><span class="n">NSTimer</span> <span class="o">*</span><span class="p">)</span><span class="nf">timerWithTimeInterval</span><span class="p">:(</span><span class="n">NSTimeInterval</span><span class="p">)</span><span class="nv">ti</span> <span class="nf">target</span><span class="p">:(</span><span class="n">id</span><span class="p">)</span><span class="nv">aTarget</span> <span class="nf">selector</span><span class="p">:(</span><span class="n">SEL</span><span class="p">)</span><span class="nv">aSelector</span> <span class="nf">userInfo</span><span class="p">:(</span><span class="n">nullable</span> <span class="n">id</span><span class="p">)</span><span class="nv">userInfo</span> <span class="nf">repeats</span><span class="p">:(</span><span class="n">BOOL</span><span class="p">)</span><span class="nv">yesOrNo</span><span class="p">;</span>

<span class="k">+</span> <span class="p">(</span><span class="n">NSTimer</span> <span class="o">*</span><span class="p">)</span><span class="nf">scheduledTimerWithTimeInterval</span><span class="p">:(</span><span class="n">NSTimeInterval</span><span class="p">)</span><span class="nv">ti</span> <span class="nf">target</span><span class="p">:(</span><span class="n">id</span><span class="p">)</span><span class="nv">aTarget</span> <span class="nf">selector</span><span class="p">:(</span><span class="n">SEL</span><span class="p">)</span><span class="nv">aSelector</span> <span class="nf">userInfo</span><span class="p">:(</span><span class="n">nullable</span> <span class="n">id</span><span class="p">)</span><span class="nv">userInfo</span> <span class="nf">repeats</span><span class="p">:(</span><span class="n">BOOL</span><span class="p">)</span><span class="nv">yesOrNo</span><span class="p">;</span>
</code></pre></div></div>
<p>è¿™ä¸¤ç§æ–¹æ³•éƒ½æ˜¯åˆ›å»ºä¸€ä¸ªå®šæ—¶å™¨ï¼ŒåŒºåˆ«æ˜¯ç”¨<code class="language-plaintext highlighter-rouge">timerWithTimeInterval:</code>æ–¹æ³•åˆ›å»ºçš„å®šæ—¶å™¨éœ€è¦æ‰‹åŠ¨åŠ å…¥RunLoopä¸­ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// åˆ›å»ºNSTimerå¯¹è±¡
NSTimer *timer = [NSTimer timerWithTimeInterval:3 target:self selector:@selector(timerAction) userInfo:nil repeats:YES];
// åŠ å…¥RunLoopä¸­
[[NSRunLoop mainRunLoop] addTimer:timer forMode:NSDefaultRunLoopMode];
</code></pre></div></div>

<p>éœ€è¦<strong>æ³¨æ„</strong>çš„æ˜¯ï¼š <code class="language-plaintext highlighter-rouge">UIScrollView</code> æ»‘åŠ¨æ—¶æ‰§è¡Œçš„æ˜¯ <code class="language-plaintext highlighter-rouge">UITrackingRunLoopMode</code>ï¼Œ<code class="language-plaintext highlighter-rouge">NSDefaultRunLoopMode</code>è¢«æŒ‚èµ·ï¼Œä¼šå¯¼è‡´å®šæ—¶å™¨å¤±æ•ˆï¼Œç­‰æ¢å¤ä¸º<strong>æ»‘åŠ¨ç»“æŸ</strong>æ—¶æ‰æ¢å¤å®šæ—¶å™¨ã€‚å…¶åŸå› å¯ä»¥æŸ¥çœ‹æˆ‘è¿™ç¯‡<a href="http://www.jianshu.com/p/c4f552ceda63">ã€ŠObjective-C RunLoop è¯¦è§£ã€‹</a>ä¸­çš„ â€œRunLoop çš„ Modeâ€œç« èŠ‚ï¼Œæœ‰è¯¦ç»†çš„ä»‹ç»ã€‚</p>

<p>ä¸¾ä¸ªä¾‹å­ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- (void)startTimer{
    NSTimer *UIScrollView = [NSTimer timerWithTimeInterval:0.5 target:self selector:@selector(action:) userInfo:nil repeats:YES];
    [[NSRunLoop mainRunLoop] addTimer:timer forMode:NSDefaultRunLoopMode];
}

- (void)action:(NSTimer *)sender {
    static int i = 0;
    NSLog(@"NSTimer: %d",i);
    i++;
}
</code></pre></div></div>

<p>å°†<code class="language-plaintext highlighter-rouge">timer</code>æ·»åŠ åˆ°<strong>NSDefaultRunLoopMode</strong>ä¸­ï¼Œæ²¡0.5ç§’æ‰“å°ä¸€æ¬¡ï¼Œç„¶åæ»‘åŠ¨<code class="language-plaintext highlighter-rouge">UIScrollView</code>.</p>

<p>æ‰“å°å°è¾“å‡ºï¼š</p>

<p><img src="http://upload-images.jianshu.io/upload_images/2178672-9de097ecc618b498.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="" /></p>

<p>å¯ä»¥çœ‹å‡ºåœ¨æ»‘åŠ¨<code class="language-plaintext highlighter-rouge">UIScrollView</code>æ—¶ï¼Œå®šæ—¶å™¨è¢«æš‚åœäº†ã€‚</p>

<p>æ‰€ä»¥å¦‚æœéœ€è¦å®šæ—¶å™¨åœ¨ <code class="language-plaintext highlighter-rouge">UIScrollView</code> æ‹–åŠ¨æ—¶ä¹Ÿä¸å½±å“çš„è¯ï¼Œæœ‰ä¸¤ç§è§£å†³æ–¹æ³•</p>

<ol>
  <li><strong>timer</strong>åˆ†åˆ«æ·»åŠ åˆ° <code class="language-plaintext highlighter-rouge">UITrackingRunLoopMode</code> å’Œ <code class="language-plaintext highlighter-rouge">NSDefaultRunLoopMode</code>ä¸­</li>
</ol>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[[</span><span class="n">NSRunLoop</span> <span class="nf">mainRunLoop</span><span class="p">]</span> <span class="nf">addTimer</span><span class="p">:</span><span class="n">timer</span> <span class="nf">forMode</span><span class="p">:</span><span class="n">NSDefaultRunLoopMode</span><span class="p">];</span>
<span class="p">[[</span><span class="n">NSRunLoop</span> <span class="nf">mainRunLoop</span><span class="p">]</span> <span class="nf">addTimer</span><span class="p">:</span><span class="n">timer</span> <span class="nf">forMode</span><span class="p">:</span> <span class="n">UITrackingRunLoopMode</span><span class="p">];</span> 
</code></pre></div></div>

<ol>
  <li>ç›´æ¥å°†<strong>timer</strong>æ·»åŠ åˆ°<code class="language-plaintext highlighter-rouge">NSRunLoopCommonModes</code> ä¸­ï¼š</li>
</ol>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[[</span><span class="n">NSRunLoop</span> <span class="nf">mainRunLoop</span><span class="p">]</span> <span class="nf">addTimer</span><span class="p">:</span><span class="n">timer</span> <span class="nf">forMode</span><span class="p">:</span> <span class="n">NSRunLoopCommonModes</span><span class="p">];</span> 
</code></pre></div></div>

<p>ä½†å¹¶ä¸æ˜¯éƒ½<strong>timer</strong>æ‰€æœ‰çš„éœ€è¦åœ¨æ»‘åŠ¨<code class="language-plaintext highlighter-rouge">UIScrollView</code>æ—¶ç»§ç»­æ‰§è¡Œï¼Œæ¯”å¦‚ä½¿ç”¨<strong>NSTimer</strong>å®Œæˆçš„å¸§åŠ¨ç”»ï¼Œæ»‘åŠ¨<code class="language-plaintext highlighter-rouge">UIScrollView</code>æ—¶å°±å¯ä»¥åœæ­¢å¸§åŠ¨ç”»ï¼Œä¿è¯æ»‘åŠ¨çš„æµç¨‹æ€§ã€‚</p>

<p>è‹¥æ²¡æœ‰ç‰¹æ®Šè¦æ±‚çš„è¯ï¼Œä¸€èˆ¬ä½¿ç”¨ç¬¬äºŒç§æ–¹æ³•åˆ›å»ºå®Œ<strong>timer</strong>ï¼Œä¼šè‡ªåŠ¨æ·»åŠ åˆ°<code class="language-plaintext highlighter-rouge">NSDefaultRunLoopMode</code>ä¸­å»æ‰§è¡Œï¼Œä¹Ÿæ˜¯å¹³æ—¶æœ€å¸¸ç”¨çš„æ–¹æ³•ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>NSTimer *timer = [NSTimer scheduledTimerWithTimeInterval:1.0 target:self selector:@selector(action:) userInfo:nil repeats:YES];
</code></pre></div></div>
<p>å‚æ•°ï¼š</p>

<p><code class="language-plaintext highlighter-rouge">TimeInterval</code>ï¼šå»¶æ—¶æ—¶é—´</p>

<p><code class="language-plaintext highlighter-rouge">target</code>:ç›®æ ‡å¯¹è±¡ï¼Œä¸€èˆ¬å°±æ˜¯<code class="language-plaintext highlighter-rouge">self</code>æœ¬èº«</p>

<p><code class="language-plaintext highlighter-rouge">selector</code>:æ‰§è¡Œæ–¹æ³•</p>

<p><code class="language-plaintext highlighter-rouge">userInfo</code>:ä¼ å…¥ä¿¡æ¯</p>

<p><code class="language-plaintext highlighter-rouge">repeats</code>:æ˜¯å¦é‡å¤æ‰§è¡Œ</p>

<p>ä»¥ä¸Šåˆ›å»ºçš„å®šæ—¶å™¨ï¼Œè‹¥<code class="language-plaintext highlighter-rouge">repeats</code>å‚æ•°è®¾ä¸º<code class="language-plaintext highlighter-rouge">NO</code>ï¼Œæ‰§è¡Œä¸€æ¬¡åå°±ä¼šè¢«é‡Šæ”¾æ‰;</p>

<p>è‹¥<code class="language-plaintext highlighter-rouge">repeats</code>å‚æ•°è®¾ä¸º<code class="language-plaintext highlighter-rouge">YES</code>é‡å¤æ‰§è¡Œæ—¶ï¼Œå¿…é¡»æ‰‹åŠ¨å…³é—­ï¼Œå¦åˆ™å®šæ—¶å™¨ä¸ä¼šé‡Šæ”¾(åœæ­¢ï¼‰ã€‚</p>

<p>é‡Šæ”¾æ–¹æ³•ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// åœæ­¢å®šæ—¶å™¨
[timer invalidate];
</code></pre></div></div>

<p>å®é™…å¼€å‘ä¸­ï¼Œæˆ‘ä»¬ä¼šå°†<code class="language-plaintext highlighter-rouge">NSTimer</code>å¯¹è±¡è®¾ç½®ä¸ºå±æ€§ï¼Œè¿™æ ·æ–¹ä¾¿é‡Šæ”¾ã€‚</p>

<p><strong>iOS10.0</strong> æ¨å‡ºäº†ä¸¤ä¸ªæ–°çš„APIï¼Œä¸ä¸Šé¢çš„æ–¹æ³•ç›¸æ¯”ï¼Œ<code class="language-plaintext highlighter-rouge">selector</code>æ¢æˆBlockå›è°ƒä»¥ã€å‡å°‘ä¼ å…¥çš„å‚æ•°(é‚£å‡ ä¸ªå‚æ•°çœŸæ˜¯é¸¡è‚‹)ã€‚ä¸è¿‡å¼€å‘ä¸­ä¸€èˆ¬éœ€è¦é€‚é…ä½ç‰ˆæœ¬ï¼Œè¿˜æ˜¯å°½é‡ä½¿ç”¨ä¸Šé¢çš„æ–¹æ³•å§ã€‚</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>+ (NSTimer *)timerWithTimeInterval:(NSTimeInterval)interval repeats:(BOOL)repeats block:(void (^)(NSTimer *timer))block API_AVAILABLE(macosx(10.12), ios(10.0), watchos(3.0), tvos(10.0));

+ (NSTimer *)scheduledTimerWithTimeInterval:(NSTimeInterval)interval repeats:(BOOL)repeats block:(void (^)(NSTimer *timer))block API_AVAILABLE(macosx(10.12), ios(10.0), watchos(3.0), tvos(10.0));
</code></pre></div></div>

<p>###ç‰¹ç‚¹</p>

<ul>
  <li>
    <p><strong>å¿…é¡»åŠ å…¥Runloop</strong></p>

    <p>ä¸Šé¢ä¸ç®¡ä½¿ç”¨å“ªç§æ–¹æ³•ï¼Œå®é™…æœ€åéƒ½ä¼šåŠ å…¥RunLoopä¸­æ‰§è¡Œï¼ŒåŒºåˆ«å°±åœ¨äºæ˜¯å¦æ‰‹åŠ¨åŠ å…¥è€Œå·²ã€‚</p>
  </li>
  <li>
    <p><strong>å­˜åœ¨å»¶è¿Ÿ</strong></p>

    <p>ä¸ç®¡æ˜¯ä¸€æ¬¡æ€§çš„è¿˜æ˜¯å‘¨æœŸæ€§çš„timerçš„å®é™…è§¦å‘äº‹ä»¶çš„æ—¶é—´ï¼Œéƒ½ä¼šä¸æ‰€åŠ å…¥çš„RunLoopå’ŒRunLoop Modeæœ‰å…³ï¼Œå¦‚æœæ­¤RunLoopæ­£åœ¨æ‰§è¡Œä¸€ä¸ªè¿ç»­æ€§çš„è¿ç®—ï¼Œtimerå°±ä¼šè¢«å»¶æ—¶å‡ºå‘ã€‚é‡å¤æ€§çš„timeré‡åˆ°è¿™ç§æƒ…å†µï¼Œå¦‚æœå»¶è¿Ÿè¶…è¿‡äº†ä¸€ä¸ªå‘¨æœŸï¼Œåˆ™ä¼šåœ¨å»¶æ—¶ç»“æŸåç«‹åˆ»æ‰§è¡Œï¼Œå¹¶æŒ‰ç…§ä¹‹å‰æŒ‡å®šçš„å‘¨æœŸç»§ç»­æ‰§è¡Œï¼Œè¿™ä¸ªå»¶è¿Ÿæ—¶é—´å¤§æ¦‚ä¸º50-100æ¯«ç§’.</p>

    <p>æ‰€ä»¥NSTimerä¸æ˜¯ç»å¯¹å‡†ç¡®çš„,è€Œä¸”ä¸­é—´è€—æ—¶æˆ–é˜»å¡é”™è¿‡ä¸‹ä¸€ä¸ªç‚¹,é‚£ä¹ˆä¸‹ä¸€ä¸ªç‚¹å°±passè¿‡å»äº†.</p>
  </li>
  <li>
    <p><strong>UIScrollViewæ»‘åŠ¨ä¼šæš‚åœè®¡æ—¶</strong></p>

    <p>æ·»åŠ åˆ°<code class="language-plaintext highlighter-rouge">NSDefaultRunLoopMode</code>çš„ <code class="language-plaintext highlighter-rouge">timer</code> åœ¨ <code class="language-plaintext highlighter-rouge">UIScrollView</code>æ»‘åŠ¨æ—¶ä¼šæš‚åœï¼Œè‹¥ä¸æƒ³è¢«<code class="language-plaintext highlighter-rouge">UIScrollView</code>æ»‘åŠ¨å½±å“ï¼Œéœ€è¦å°† <code class="language-plaintext highlighter-rouge">timer</code> æ·»åŠ å†åˆ° <code class="language-plaintext highlighter-rouge">UITrackingRunLoopMode</code> æˆ– ç›´æ¥æ·»åŠ åˆ°<code class="language-plaintext highlighter-rouge">NSRunLoopCommonModes</code> ä¸­</p>
  </li>
</ul>

<p>##CADisplayLink</p>

<p>CADisplayLinkå®˜æ–¹ä»‹ç»ï¼š</p>
<blockquote>
  <p>A CADisplayLink object is a timer object that allows your application to synchronize its drawing to the refresh rate of the display</p>
</blockquote>

<p><strong>CADisplayLink</strong>å¯¹è±¡æ˜¯ä¸€ä¸ªå’Œå±å¹•åˆ·æ–°ç‡åŒæ­¥çš„å®šæ—¶å™¨å¯¹è±¡ã€‚æ¯å½“å±å¹•æ˜¾ç¤ºå†…å®¹åˆ·æ–°ç»“æŸçš„æ—¶å€™ï¼Œrunloopå°±ä¼šå‘CADisplayLinkæŒ‡å®šçš„<code class="language-plaintext highlighter-rouge">target</code>å‘é€ä¸€æ¬¡æŒ‡å®šçš„<code class="language-plaintext highlighter-rouge">selector</code>æ¶ˆæ¯ï¼Œ CADisplayLinkç±»å¯¹åº”çš„ <code class="language-plaintext highlighter-rouge">selector</code> å°±ä¼šè¢«è°ƒç”¨ä¸€æ¬¡ã€‚</p>

<p>ä»åŸç†ä¸Šå¯ä»¥çœ‹å‡ºï¼ŒCADisplayLinké€‚åˆåšç•Œé¢çš„ä¸åœé‡ç»˜ï¼Œæ¯”å¦‚è§†é¢‘æ’­æ”¾çš„æ—¶å€™éœ€è¦ä¸åœåœ°è·å–ä¸‹ä¸€å¸§ç”¨äºç•Œé¢æ¸²æŸ“ï¼Œæˆ–è€…åšåŠ¨ç”»ã€‚
###ä½¿ç”¨æ–¹æ³•</p>

<p>åˆ›å»ºï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>@property (nonatomic, strong) CADisplayLink *displayLink;

self.displayLink = [CADisplayLink displayLinkWithTarget:self selector:@selector(handleDisplayLink:)];  

// æ¯éš”1å¸§è°ƒç”¨ä¸€æ¬¡
self.displayLink.frameInterval = 1;  

[self.displayLink addToRunLoop:[NSRunLoop currentRunLoop] forMode:NSDefaultRunLoopMode];
</code></pre></div></div>
<p>é‡Šæ”¾æ–¹æ³•ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[self.displayLink invalidate];  

self.displayLink = nil;
</code></pre></div></div>
<p>å½“æŠŠ<strong>CADisplayLink</strong>å¯¹è±¡æ·»åŠ åˆ°runloopä¸­åï¼Œ<code class="language-plaintext highlighter-rouge">selector</code>å°±èƒ½è¢«å‘¨æœŸæ€§è°ƒç”¨ï¼Œç±»ä¼¼äºé‡å¤çš„NSTimerè¢«å¯åŠ¨äº†ï¼›æ‰§è¡Œ<code class="language-plaintext highlighter-rouge">invalidate</code>æ“ä½œæ—¶ï¼ŒCADisplayLinkå¯¹è±¡å°±ä¼šä»runloopä¸­ç§»é™¤ï¼Œ<code class="language-plaintext highlighter-rouge">selector</code>è°ƒç”¨ä¹Ÿéšå³åœæ­¢ï¼Œç±»ä¼¼äºNSTimerçš„<code class="language-plaintext highlighter-rouge">invalidate</code>æ–¹æ³•ã€‚</p>

<p><strong>CADisplayLink</strong>ä¸­æœ‰ä¸¤ä¸ªé‡è¦çš„å±æ€§ï¼š</p>

<ul>
  <li>
    <p><strong>frameInterval</strong></p>

    <p>NSIntegerç±»å‹çš„å€¼ï¼Œç”¨æ¥è®¾ç½®é—´éš”å¤šå°‘å¸§è°ƒç”¨ä¸€æ¬¡<code class="language-plaintext highlighter-rouge">selector</code>æ–¹æ³•ï¼Œé»˜è®¤å€¼æ˜¯1ï¼Œå³æ¯å¸§éƒ½è°ƒç”¨ä¸€æ¬¡ã€‚</p>
  </li>
  <li>
    <p><strong>duration</strong></p>

    <p><code class="language-plaintext highlighter-rouge">CFTimeInterval</code>å€¼ä¸º<code class="language-plaintext highlighter-rouge">readOnly</code>ï¼Œè¡¨ç¤ºä¸¤æ¬¡å±å¹•åˆ·æ–°ä¹‹é—´çš„æ—¶é—´é—´éš”ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¯¥å±æ€§åœ¨<code class="language-plaintext highlighter-rouge">targe</code>tçš„<code class="language-plaintext highlighter-rouge">selector</code>è¢«é¦–æ¬¡è°ƒç”¨ä»¥åæ‰ä¼šè¢«èµ‹å€¼ã€‚<code class="language-plaintext highlighter-rouge">selector</code>çš„è°ƒç”¨é—´éš”æ—¶é—´è®¡ç®—æ–¹å¼æ˜¯ï¼š<strong>è°ƒç”¨é—´éš”æ—¶é—´ = duration Ã— frameInterval</strong>ã€‚</p>
  </li>
</ul>

<p>###ç‰¹ç‚¹</p>

<ul>
  <li>
    <p><strong>åˆ·æ–°é¢‘ç‡å›ºå®š</strong></p>

    <p>æ­£å¸¸æƒ…å†µiOSè®¾å¤‡çš„å±å¹•åˆ·æ–°é¢‘ç‡æ˜¯å›ºå®š<strong>60Hz</strong>,å¦‚æœCPUè¿‡äºç¹å¿™ï¼Œæ— æ³•ä¿è¯å±å¹•60æ¬¡/ç§’çš„åˆ·æ–°ç‡ï¼Œå°±ä¼šå¯¼è‡´è·³è¿‡è‹¥å¹²æ¬¡è°ƒç”¨å›è°ƒæ–¹æ³•çš„æœºä¼šï¼Œè·³è¿‡æ¬¡æ•°å–å†³CPUçš„å¿™ç¢Œç¨‹åº¦ã€‚</p>
  </li>
  <li>
    <p><strong>å±å¹•åˆ·æ–°æ—¶è°ƒç”¨</strong></p>

    <p>CADisplayLinkåœ¨æ­£å¸¸æƒ…å†µä¸‹ä¼šåœ¨æ¯æ¬¡åˆ·æ–°ç»“æŸéƒ½è¢«è°ƒç”¨ï¼Œç²¾ç¡®åº¦ç›¸å½“é«˜ã€‚ä½†å¦‚æœè°ƒç”¨çš„æ–¹æ³•æ¯”è¾ƒè€—æ—¶ï¼Œè¶…è¿‡äº†å±å¹•åˆ·æ–°å‘¨æœŸï¼Œå°±ä¼šå¯¼è‡´è·³è¿‡è‹¥å¹²æ¬¡å›è°ƒè°ƒç”¨æœºä¼š</p>
  </li>
  <li>
    <p><strong>é€‚åˆåšç•Œé¢æ¸²æŸ“</strong></p>

    <p>CADisplayLinkå¯ä»¥ç¡®ä¿ç³»ç»Ÿæ¸²æŸ“æ¯ä¸€å¸§çš„æ—¶å€™æˆ‘ä»¬çš„æ–¹æ³•éƒ½è¢«è°ƒç”¨ï¼Œä»è€Œä¿è¯äº†åŠ¨ç”»çš„æµç•…æ€§ã€‚</p>
  </li>
</ul>

<p>##GCDå®šæ—¶å™¨</p>

<p><strong>GCDå®šæ—¶å™¨</strong>å’ŒNSTimeræ˜¯ä¸ä¸€æ ·çš„ï¼ŒNSTimerå—RunLoopå½±å“ï¼Œä½†æ˜¯GCDçš„å®šæ—¶å™¨ä¸å—å½±å“ï¼Œå› ä¸ºé€šè¿‡æºç å¯çŸ¥RunLoopä¹Ÿæ˜¯åŸºäºGCDçš„å®ç°çš„ï¼Œæ‰€ä»¥GCDå®šæ—¶å™¨æœ‰éå¸¸é«˜çš„ç²¾åº¦ã€‚å…³äºGCDçš„ä½¿ç”¨å¯ä¸€çœ‹çœ‹<a href="http://www.cnblogs.com/pure/archive/2013/03/31/2977420.html">è¿™ç¯‡åšå®¢</a>ã€‚</p>

<p>###ä½¿ç”¨æ–¹æ³•
åˆ›å»ºGCDå®šæ—¶å™¨å®šæ—¶å™¨çš„æ–¹æ³•ç¨å¾®æ¯”è¾ƒå¤æ‚ï¼Œçœ‹ä¸‹é¢çš„ä»£ç ï¼š</p>

<p>####å•æ¬¡çš„å»¶æ—¶è°ƒç”¨
NSObjectä¸­çš„<code class="language-plaintext highlighter-rouge">performSelector:withObject:afterDelay:</code>ä»¥åŠ <code class="language-plaintext highlighter-rouge">performSelector:withObject:afterDelay:inModes:</code> è¿™ä¸¤ä¸ªæ–¹æ³•åœ¨è°ƒç”¨çš„æ—¶å€™ä¼šè®¾ç½®å½“å‰ runloop ä¸­ <code class="language-plaintext highlighter-rouge">timer</code> ï¼Œå‰è€…è®¾ç½®çš„ <code class="language-plaintext highlighter-rouge">timer</code> åœ¨ <code class="language-plaintext highlighter-rouge">NSDefaultRunLoopMode</code> è¿è¡Œï¼Œåè€…åˆ™å¯ä»¥æŒ‡å®š <strong>NSRunLoop</strong> çš„ <code class="language-plaintext highlighter-rouge">mode</code> æ¥æ‰§è¡Œã€‚æˆ‘ä»¬ä¸Šé¢ä»‹ç»è¿‡ runloop ä¸­ <code class="language-plaintext highlighter-rouge">timer</code> åœ¨ <code class="language-plaintext highlighter-rouge">UITrackingRunLoopMode</code> è¢«æŒ‚èµ·ï¼Œå°±å¯¼è‡´äº†ä»£ç å°±ä¼šä¸€ç›´ç­‰å¾… <code class="language-plaintext highlighter-rouge">timer</code> çš„è°ƒåº¦,è§£å†³åŠæ³•åœ¨ä¸Šé¢ä¹Ÿæœ‰è¯´æ˜ã€‚</p>

<p>ä¸è¿‡æˆ‘ä»¬å¯ä»¥ç”¨å¦ä¸€å¥—æ–¹æ¡ˆæ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå°±æ˜¯ä½¿ç”¨GCDä¸­çš„ <code class="language-plaintext highlighter-rouge">dispatch_after</code> æ¥å®ç°å•æ¬¡çš„å»¶æ—¶è°ƒç”¨ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>double delayInSeconds = 2.0;
    dispatch_time_t popTime = dispatch_time(DISPATCH_TIME_NOW, (int64_t)(delayInSeconds * NSEC_PER_SEC));
    dispatch_after(popTime, dispatch_get_main_queue(), ^(void){
        [self someMethod];
    });
</code></pre></div></div>

<p>####å¾ªç¯è°ƒç”¨</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// åˆ›å»ºGCDå®šæ—¶å™¨
dispatch_queue_t queue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0);

dispatch_source_t _timer = dispatch_source_create(DISPATCH_SOURCE_TYPE_TIMER, 0, 0, queue);

dispatch_source_set_timer(_timer, dispatch_walltime(NULL, 0), 1.0 * NSEC_PER_SEC, 0); //æ¯ç§’æ‰§è¡Œ

// äº‹ä»¶å›è°ƒ
dispatch_source_set_event_handler(_timer, ^{
        
    dispatch_async(dispatch_get_main_queue(), ^{
        // åœ¨ä¸»çº¿ç¨‹ä¸­å®ç°éœ€è¦çš„åŠŸèƒ½
        
	}
}
    
});

// å¼€å¯å®šæ—¶å™¨
dispatch_resume(_timer);

// æŒ‚èµ·å®šæ—¶å™¨ï¼ˆdispatch_suspend ä¹‹åçš„ Timerï¼Œæ˜¯ä¸èƒ½è¢«é‡Šæ”¾çš„ï¼ä¼šå¼•èµ·å´©æºƒï¼‰
dispatch_suspend(_timer);

// å…³é—­å®šæ—¶å™¨
dispatch_source_cancel(_timer);
    
</code></pre></div></div>

<p>ä¸Šé¢ä»£ç ä¸­è¦æ³¨æ„çš„æ˜¯ï¼š</p>

<ol>
  <li><code class="language-plaintext highlighter-rouge">dispatch_source_set_event_handler()</code>ä¸­çš„ä»»åŠ¡å®åœ¨å­çº¿ç¨‹ä¸­æ‰§è¡Œçš„ï¼Œè‹¥éœ€è¦å›åˆ°ä¸»çº¿ç¨‹ï¼Œè¦è°ƒç”¨<code class="language-plaintext highlighter-rouge">dispatch_async(dispatch_get_main_queue(), ^{}</code>.
    <ul>
      <li><code class="language-plaintext highlighter-rouge">dispatch_source_set_timer</code> ä¸­ç¬¬äºŒä¸ªå‚æ•°ï¼Œå½“æˆ‘ä»¬ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">dispatch_time</code> æˆ–è€… <code class="language-plaintext highlighter-rouge">DISPATCH_TIME_NOW</code> æ—¶ï¼Œç³»ç»Ÿä¼šä½¿ç”¨é»˜è®¤æ—¶é’Ÿæ¥è¿›è¡Œè®¡æ—¶ã€‚ç„¶è€Œå½“ç³»ç»Ÿä¼‘çœ çš„æ—¶å€™ï¼Œé»˜è®¤æ—¶é’Ÿæ˜¯ä¸èµ°çš„ï¼Œä¹Ÿå°±ä¼šå¯¼è‡´è®¡æ—¶å™¨åœæ­¢ã€‚ä½¿ç”¨ <code class="language-plaintext highlighter-rouge">dispatch_walltime </code> å¯ä»¥è®©è®¡æ—¶å™¨æŒ‰ç…§çœŸå®æ—¶é—´é—´éš”è¿›è¡Œè®¡æ—¶.</li>
      <li>ç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œ ` 1.0 * NSEC_PER_SEC` ä¸ºæ¯ç§’æ‰§è¡Œä¸€æ¬¡ï¼Œå¯¹åº”çš„è¿˜æœ‰æ¯«ç§’ï¼Œåˆ†ç§’ï¼Œçº³ç§’å¯ä»¥é€‰æ‹©.</li>
    </ul>
  </li>
</ol>

<ul>
  <li><code class="language-plaintext highlighter-rouge">dispatch_source_set_event_handler</code> è¿™ä¸ªå‡½æ•°åœ¨æ‰§è¡Œå®Œä¹‹åï¼Œblock ä¼šç«‹é©¬æ‰§è¡Œä¸€éï¼Œåé¢éš”ä¸€å®šæ—¶é—´é—´éš”å†æ‰§è¡Œä¸€æ¬¡ã€‚è€Œ <code class="language-plaintext highlighter-rouge">NSTimer</code> ç¬¬ä¸€æ¬¡æ‰§è¡Œæ˜¯åˆ°è®¡æ—¶å™¨è§¦å‘ä¹‹åã€‚è¿™ä¹Ÿæ˜¯å’Œ <code class="language-plaintext highlighter-rouge">NSTimer</code> ä¹‹é—´çš„ä¸€ä¸ªæ˜¾è‘—åŒºåˆ«ã€‚</li>
  <li>æŒ‚èµ·ï¼ˆæš‚åœï¼‰å®šæ—¶å™¨, <code class="language-plaintext highlighter-rouge">dispatch_suspend</code> ä¹‹åçš„ <code class="language-plaintext highlighter-rouge">Timer</code>ï¼Œä¸èƒ½è¢«é‡Šæ”¾çš„,ä¼šå¼•èµ·å´©æºƒ.</li>
  <li>åˆ›å»ºçš„<code class="language-plaintext highlighter-rouge">timer</code>ä¸€å®šè¦æœ‰<code class="language-plaintext highlighter-rouge">dispatch_suspend(_timer)</code>æˆ–<code class="language-plaintext highlighter-rouge">dispatch_source_cancel(_timer)</code>è¿™ä¸¤å¥è¯æ¥æŒ‡å®šå‡ºå£ï¼Œå¦åˆ™å®šæ—¶å™¨å°†ä¸æ‰§è¡Œï¼Œè‹¥æˆ‘ä»¬æƒ³æ— é™å¾ªç¯å¯å°† <code class="language-plaintext highlighter-rouge">dispatch_source_cancel(_timer)</code> å†™åœ¨ä¸€å¥æ°¸ä¸æ‰§è¡Œçš„<code class="language-plaintext highlighter-rouge">if</code>åˆ¤æ–­è¯­å¥ä¸­ã€‚</li>
</ul>

<p>##ä½¿ç”¨åœºæ™¯</p>

<p>ä»‹ç»å®ŒiOSä¸­çš„å„ç§å®šæ—¶å™¨ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥è¯´è¯´è¿™å‡ ç§å®šæ—¶å™¨åœ¨å¼€å‘ä¸­çš„å‡ ç§ç”¨æ³•ã€‚
###çŸ­ä¿¡é‡å‘å€’è®¡æ—¶</p>

<p>çŸ­ä¿¡å€’è®¡æ—¶ä½¿æˆ‘ä»¬ç™»å½•æ³¨å†Œå¸¸ç”¨çš„åŠŸèƒ½ï¼Œä¸€èˆ¬è®¾ç½®ä¸º60sï¼Œå®ç°æ–¹æ³•å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// è®¡æ—¶æ—¶é—´
@property (nonatomic, assign) int timeout;

/** å¼€å¯å€’è®¡æ—¶ */
- (void)startCountdown {
    
    if (_timeout &gt; 0) {
        return;
    }
    
    _timeout = 60;
    
    // GCDå®šæ—¶å™¨
    dispatch_queue_t queue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0);
    
    dispatch_source_t _timer = dispatch_source_create(DISPATCH_SOURCE_TYPE_TIMER, 0, 0, queue);
    
    dispatch_source_set_timer(_timer, dispatch_walltime(NULL, 0), 1.0 * NSEC_PER_SEC, 0); //æ¯ç§’æ‰§è¡Œ
    
    dispatch_source_set_event_handler(_timer, ^{
        
        if(_timeout &lt;= 0 ){// å€’è®¡æ—¶ç»“æŸ
            
            // å…³é—­å®šæ—¶å™¨
            dispatch_source_cancel(_timer);
            
            dispatch_async(dispatch_get_main_queue(), ^{
                
                //è®¾ç½®ç•Œé¢çš„æŒ‰é’®æ˜¾ç¤º æ ¹æ®è‡ªå·±éœ€æ±‚è®¾ç½®
                [self.sendMsgBtn setTitle:@"å‘é€" forState:UIControlStateNormal];
                
                self.sendMsgBtn.enabled = YES;
                
            });
            
        }else{// å€’è®¡æ—¶ä¸­
            
            // æ˜¾ç¤ºå€’è®¡æ—¶ç»“æœ
            
            NSString *strTime = [NSString stringWithFormat:@"é‡å‘(%.2d)", _timeout];
            
            dispatch_async(dispatch_get_main_queue(), ^{
                
                //è®¾ç½®ç•Œé¢çš„æŒ‰é’®æ˜¾ç¤º æ ¹æ®è‡ªå·±éœ€æ±‚è®¾ç½®
                
                [self.sendMsgBtn setTitle:[NSString stringWithFormat:@"%@",strTime] forState:UIControlStateNormal];
                
                self.sendMsgBtn.enabled = NO;
                
            });
            
            _timeout--;
        }
    });
    
    // å¼€å¯å®šæ—¶å™¨
    dispatch_resume(_timer);
    
}
</code></pre></div></div>

<p>åœ¨ä¸Šé¢ä»£ç ä¸­ï¼Œæˆ‘ä»¬è®¾ç½®äº†ä¸€ä¸ª60så¾ªç¯å€’è®¡æ—¶ï¼Œå½“æˆ‘ä»¬å‘æœåŠ¡å™¨è·å–çŸ­ä¿¡éªŒè¯ç æˆåŠŸæ—¶ è°ƒç”¨è¯¥æ–¹æ³•å¼€å§‹å€’è®¡æ—¶ã€‚æ¯ç§’åˆ·æ–°æŒ‰é’®çš„å€’è®¡æ—¶æ•°ï¼Œå€’è®¡æ—¶ç»“æŸæ—¶å†å°†æŒ‰é’® <code class="language-plaintext highlighter-rouge">Title</code> æ¢å¤ä¸ºâ€œå‘é€â€.</p>

<p>æœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒæŒ‰é’®çš„æ ·å¼è¦è®¾ç½®ä¸º <strong>UIButtonTypeCustom</strong>,å¦åˆ™ä¼šå‡ºç°åˆ·æ–° <code class="language-plaintext highlighter-rouge">Title</code> æ—¶é—ªçƒ.</p>

<p>æˆ‘ä»¬å¯ä»¥æŠŠè¿™ä¸ªæ–¹æ³•å°è£…ä¸€ä¸‹ï¼Œæ–¹ä¾¿è°ƒç”¨ï¼Œå¦åˆ™åœ¨æ§åˆ¶å™¨ä¸­å†™è¿™ä¹ˆä¸€å¤§æ®µä»£ç ç¡®å®ä¹Ÿä¸ä¼˜é›…ã€‚</p>

<p>æ•ˆæœå¦‚ä¸‹ï¼š</p>

<p><img src="http://upload-images.jianshu.io/upload_images/2178672-3d4d1353bcc36026.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="" /></p>

<h5 id="ä»£ç é“¾æ¥"><a href="https://github.com/qiubaiying/BYTimer">ä»£ç é“¾æ¥</a></h5>

<p>###æ¯ä¸ªå‡ åˆ†é’Ÿå‘æœåŠ¡å™¨å‘é€æ•°æ®</p>

<p>åœ¨æœ‰å®šä½æœåŠ¡çš„APPä¸­ï¼Œæˆ‘ä»¬éœ€è¦æ¯ä¸ªä¸€æ®µæ—¶é—´å°†å®šä½æ•°æ®å‘é€åˆ°æœåŠ¡å™¨ï¼Œæ¯”å¦‚æ¯5så®šä½ä¸€æ¬¡æ¯éš”5åˆ†é’Ÿå°†å†ç»Ÿä¸€å°†æ•°æ®å‘é€æœåŠ¡å™¨ï¼Œè¿™æ ·ä¼šå¤„ç†æ¯”è¾ƒçœç”µã€‚
ä¸€èˆ¬ç¨‹åºè¿›å…¥åå°æ—¶ï¼Œå®šæ—¶å™¨ä¼šåœæ­¢ï¼Œä½†æ˜¯åœ¨å®šä½APPä¸­ï¼Œéœ€è¦æŒç»­è¿›è¡Œå®šä½ï¼ŒAPPåœ¨åå°æ—¶ä¾æ—§å¯ä»¥è¿è¡Œï¼Œæ‰€ä»¥åœ¨åå°å®šæ—¶å™¨ä¹Ÿæ˜¯å¯ä»¥è¿è¡Œçš„ã€‚</p>

<p>æ³¨ï¼šå…³äºiOSåå°å¸¸é©»,å¯ä»¥æŸ¥çœ‹<a href="http://waitingyuan.blog.163.com/blog/static/2155781652014111133150534/">è¿™ç¯‡åšå®¢</a></p>

<p>åœ¨ä½¿ç”¨GCDå®šæ—¶çš„æ—¶å€™å‘ç°GCDå®šæ—¶å™¨ä¹Ÿå¯ä»¥åœ¨åä»£è¿è¡Œï¼Œåˆ›å»ºæ–¹æ³•åŒä¸Šé¢çš„çŸ­ä¿¡å€’è®¡æ—¶.</p>

<p>è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨<strong>NSTimer</strong>æ¥åˆ›å»ºä¸€ä¸ªæ¯ä¸ª5åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡çš„å®šæ—¶å™¨.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#import &lt;Foundation/Foundation.h&gt;

typedef void(^TimerBlock)();

@interface BYTimer : NSObject

- (void)startTimerWithBlock:(TimerBlock)timerBlock;

- (void)stopTimer;

@end

</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#import "BYTimer.h"

@interface BYTimer ()

@property (nonatomic, strong) NSTimer *timer;
@property (nonatomic, strong) TimerBlock timerBlock;

@end

@implementation BYTimer

- (void)startTimerWithBlock:(TimerBlock)timerBlock {

	 self.timer = [NSTimer timerWithTimeInterval:300 target:self selector:@selector(_timerAction) userInfo:nil repeats:YES];
	 
    [[NSRunLoop mainRunLoop] addTimer:self.timer forMode:NSRunLoopCommonModes];
    _timerBlock = timerBlock;
    
}

- (void)_timerAction {
    if (self.timerBlock) {
        self.timerBlock();
    }
}

- (void)stopTimer {
    [self.timer invalidate];
}

@end
</code></pre></div></div>

<p>è¯¥æ¥å£çš„å®ç°å¾ˆç®€å•ï¼Œå°±æ˜¯ <strong>NSTimer</strong> åˆ›å»ºäº†ä¸€ä¸ª300sæ‰§è¡Œä¸€æ¬¡çš„å®šæ—¶å™¨ï¼Œä½†æ˜¯è¦æ³¨æ„å®šæ—¶å™¨éœ€è¦åŠ å…¥<code class="language-plaintext highlighter-rouge">NSRunLoopCommonModes</code>ä¸­ã€‚</p>

<p>è¦ä½¿å®šæ—¶å™¨åœ¨åå°èƒ½è¿è¡Œï¼Œapp å°±éœ€è¦åœ¨ <a href="http://waitingyuan.blog.163.com/blog/static/2155781652014111133150534/">åå°å¸¸é©»</a>ã€‚</p>

<h1 id="ç»“è¯­">ç»“è¯­</h1>

<p>æœ€åæ€»ç»“ä¸€ä¸‹ï¼š</p>

<p>NSTimer ä½¿ç”¨ç®€å•æ–¹ä¾¿ï¼Œä½†æ˜¯åº”ç”¨æ¡ä»¶æœ‰é™ã€‚</p>

<p>CADisplayLink åˆ·æ–°é¢‘ç‡ä¸å±å¹•å¸§æ•°ç›¸åŒï¼Œç”¨äºç»˜åˆ¶åŠ¨ç”»ã€‚å…·ä½“ä½¿ç”¨å¯çœ‹æˆ‘å°è£…å¥½çš„ä¸€ä¸ª <a href="https://github.com/qiubaiying/WaterRippleView">æ°´æ³¢çº¹åŠ¨ç”»</a>ã€‚</p>

<p>GCDå®šæ—¶å™¨ ç²¾åº¦é«˜ï¼Œå¯æ§æ€§å¼ºï¼Œä½¿ç”¨ç¨å¤æ‚ã€‚</p>
:ET